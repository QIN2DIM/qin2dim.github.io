<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="哪吒监控敏捷部署"><title>『Blog』NeZha Monitoring 从一到无穷大</title><link rel=canonical href=https://blog.echosec.top/p/nezha-monitoring/><link rel=stylesheet href=/scss/style.min.00066413cf5b11ff83f68f901cd98368c0b2d6327b373ddf957666a5c4d92db2.css><meta property="og:title" content="『Blog』NeZha Monitoring 从一到无穷大"><meta property="og:description" content="哪吒监控敏捷部署"><meta property="og:url" content="https://blog.echosec.top/p/nezha-monitoring/"><meta property="og:site_name" content="Echosec @QIN2DIM"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="NeZha"><meta property="article:published_time" content="2023-06-17T18:39:06+08:00"><meta property="article:modified_time" content="2023-06-17T18:39:06+08:00"><meta property="og:image" content="https://blog.echosec.top/p/nezha-monitoring/wanderer4.jpg"><meta name=twitter:site content="@Alkaid20860233"><meta name=twitter:creator content="@Alkaid20860233"><meta name=twitter:title content="『Blog』NeZha Monitoring 从一到无穷大"><meta name=twitter:description content="哪吒监控敏捷部署"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.echosec.top/p/nezha-monitoring/wanderer4.jpg"><link rel="shortcut icon" href=https://cdn.jsdelivr.net/gh/qin2dim/cdn-relay@main/avatars/watercolour-4817390__480.jpg><link rel=stylesheet href=//cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css><script async src=https://busuanzi.icodeq.com/busuanzi.pure.mini.js></script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"light")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/62018067_hu01b1850304f2a433574ed2470395348a_321911_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a>
<span class=emoji>🎯</span></figure><div class=site-meta><h1 class=site-name><a href=/>Echosec @QIN2DIM</a></h1><h2 class=site-description>A Creator from China.</h2></div></header><ol class=social-menu><li><a href=https://github.com/QIN2DIM target=_blank title=GitHub><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com/Tk206_ target=_blank title=Twitter><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li><li><a href=https://nav.echosec.top target=_blank title=Navigator><!doctype html><svg t="1635028836276" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="9207" width="128" height="128" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><style/></defs><path d="M782.802 129.086c3.079.0 5.884 2.805 5.884 5.884v744.58L561.591 601.177 512 540.387l-49.591 60.789-227.095 278.375v-744.58c0-3.08 2.805-5.884 5.884-5.884h541.604m0-64.001H241.198c-38.436.0-69.884 31.448-69.884 69.884v768.729c.276 33.712 27.781 55.214 56.065 55.214 15.368.0 30.969-6.353 42.548-20.546L512 641.633 753.023 937.08c11.68 14.317 27.793 20.773 43.661 20.773 28.115.0 55.458-20.27 55.993-53.003.006-.383.009-.767.009-1.151V134.971c0-38.437-31.447-69.885-69.884-69.885z" p-id="9208" fill="#bababa"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/links><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg><span>Links</span></a></li><li><a href=/archives><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>暗色模式</span></li></div></ol></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/nezha-monitoring/><img src=/p/nezha-monitoring/wanderer4_huf18331c9a1d279d8d1eb1f131ae90b4b_1493237_800x0_resize_q75_box.jpg srcset="/p/nezha-monitoring/wanderer4_huf18331c9a1d279d8d1eb1f131ae90b4b_1493237_800x0_resize_q75_box.jpg 800w, /p/nezha-monitoring/wanderer4_huf18331c9a1d279d8d1eb1f131ae90b4b_1493237_1600x0_resize_q75_box.jpg 1600w" width=800 height=405 loading=lazy alt="Featured image of post 『Blog』NeZha Monitoring 从一到无穷大"></a></div><div class=article-details><header class=article-category><a href=/categories/software-engineering/ style=background-color:#cfb887;color:#fff>Software Engineering</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/nezha-monitoring/>『Blog』NeZha Monitoring 从一到无穷大</a></h2><h3 class=article-subtitle>哪吒监控敏捷部署</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>2023-06-17</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>阅读时长: 8 分钟</time></div></footer></div></header><section class=article-content><h2 id=preview>Preview</h2><p><img src=/p/nezha-monitoring/image-20230617192034418.png width=1488 height=1123 srcset="/p/nezha-monitoring/image-20230617192034418_hu0ac0ece9aa252182b1b5f623f9ab6e98_118119_480x0_resize_box_3.png 480w, /p/nezha-monitoring/image-20230617192034418_hu0ac0ece9aa252182b1b5f623f9ab6e98_118119_1024x0_resize_box_3.png 1024w" loading=lazy alt="NeZha Monitoring Dashboard - Default Theme" class=gallery-image data-flex-grow=132 data-flex-basis=318px></p><h3 id=简介>简介</h3><p><strong><a class=link href=https://nezha.wiki/index.html target=_blank rel=noopener>哪吒监控</a></strong> 是一个开源、轻量的服务器和网站监控、运维工具，它具备以下特点：</p><ol><li><strong>实时监控</strong>：支持同时监控多个服务器的系统状态，监控网页、端口、SSL证书状态等，并可配置故障、流量等状态报警。多种通知方式（Telegram、邮件、微信等）可供选择。</li><li><strong>轻量运维</strong>：支持在线SSH，支持流量循环监控，支持设置定时任务、服务器批量执行任务。</li></ol><h3 id=先决条件>先决条件</h3><p>在下一节的速通攻略中，我们将介绍一种哪吒监控系统敏捷部署方案。面板节点使用 Cloudflare CDN + NGINX 反向代理 + HTTPS 域名架构，实现在线访问功能。开始操作前请确保你已具备如下先决条件：</p><ol><li><p><strong>准备一台或多台 VPS</strong></p><p>VPS 需要放行 8008 和 5555 端口。其中，8008 是面板端口，5555 用于传输被控节点的资源状态。</p></li><li><p><strong>选择一台 VPS 作为面板节点</strong></p><p>在 Cloudflare 中解析两条 A 记录指向这个节点。其中一条用于 CDN 连接。在添加记录时，不要开启“小云朵”。Cloudflare 支持且默认开启 CDN WebSocket。</p><p>对于面板节点而言，单核 512MB 内存的服务器配置就足以满足大多数使用场景。</p><p>需要额外注意面板节点 80 和 443 端口的放行和占用情况。我们后续会使用 certbot 申请免费域名证书，请确保端口处于空闲状态。</p></li><li><p><strong>一个用于 OAuth2.0 授权的 GitHub 账号</strong></p></li></ol><h2 id=get-started>Get started</h2><h3 id=setup>Setup</h3><p>在一切开始前，我们假设（定义）如下变量：</p><ol><li>面板 CDN 域名：如 <code>cdn.happy.live</code>。一切从外来流量访问这个域名。</li><li>面板直连域名：如 <code>dash.happy.live</code>。仅供 NeZha Monitoring 内部节点通信使用。</li></ol><p>将你解析的域名同等替换即可。之后的操作以 Ubuntu20.04 为例。</p><h3 id=github-oauth20-应用申请>GitHub OAuth2.0 应用申请</h3><p>访问 <a class=link href=https://github.com/settings/applications/new target=_blank rel=noopener>New OAuth Application</a>，注册一个新的 OAuth 应用：</p><div class=table-wrapper><table><thead><tr><th>Item</th><th>Value</th></tr></thead><tbody><tr><td>Application name</td><td>随便写，比如 <code>NeZha Monitoring Dashboard</code></td></tr><tr><td>Homepage URL</td><td>填 HTTPS 架构域名，比如 <code>https://cdn.happy.live</code></td></tr><tr><td>Authorization callback URL</td><td>同上，填写 NeZha 的<code>redirect_uri</code>，<code>https://cdn.happy.live/oauth2/callback</code></td></tr></tbody></table></div><p>注册完成后，New 一个 <code>Client secrets</code> ，并记下 <code>Client ID</code> 和 <code>Client secrets</code>后面会用到。</p><h3 id=拉起面板节点>拉起面板节点</h3><p>SSH 连上面板节点，执行以下命令安装引导脚本<a class=link href=https://nezha.wiki/guide/dashboard.html#%E5%9C%A8%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%AD%E5%AE%89%E8%A3%85-dashboard target=_blank rel=noopener>&lt;documentation></a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -L https://raw.githubusercontent.com/naiba/nezha/master/script/install.sh  -o nezha.sh <span class=o>&amp;&amp;</span> chmod +x nezha.sh <span class=o>&amp;&amp;</span> sudo ./nezha.sh
</span></span></code></pre></td></tr></table></div></div><p>等待Docker安装完毕后，选择安装监控面板，分别输入以下值：</p><div class=table-wrapper><table><thead><tr><th>Item</th><th>Action</th></tr></thead><tbody><tr><td>OAuth提供商</td><td>回车选用默认配置，GitHub</td></tr><tr><td>Client ID</td><td>Client ID of your OAuth APP</td></tr><tr><td>Client Secret</td><td>Client Secret of your OAuth APP</td></tr><tr><td>用户名</td><td>Your GitHub username</td></tr><tr><td>站点标题</td><td>随便写</td></tr><tr><td>访问端口</td><td>回车选用默认配置，8008</td></tr><tr><td>Agent的通信端口</td><td>回车选用默认配置，5555</td></tr></tbody></table></div><p>输入完成后，等待拉取镜像，安装结束后，如果一切正常，此时你可以访问 <code>IP+端口号</code>，如:</p><p><code>http://your-server-ip:8008</code>，注意此时只能通过 HTTP 架构访问。</p><h3 id=配置面板节点>配置面板节点</h3><h4 id=申请证书>申请证书</h4><ol><li><p>安装 certbot</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo apt update
</span></span><span class=line><span class=cl>sudo apt install certbot
</span></span></code></pre></td></tr></table></div></div></li><li><p>如果已运行 NGINX 请先停止它再运行脚本。如果其他进程占用了 80/443 端口，也会影响证书申请。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>nginx -s stop
</span></span></code></pre></td></tr></table></div></div></li><li><p>安装证书</p><p><code>-d</code> 后接证书绑定域名，也即，从 Cloudflare 解析到面板节点的 CDN 域名。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo certbot certonly --standalone --register-unsafely-without-email -d <span class=o>[</span>你的面板CDN域名<span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>检查证书路径</p><p>在默认情况下，证书文件 .pem 将被发送到以下路径：<code>/etc/letsencrypt/live/[domain]/</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 证书文件路径</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ssl_certificate</span><span class=p>:</span><span class=w> </span><span class=l>/etc/letsencrypt/live/[domain]/fullchain.pem </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 私钥文件路径</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ssl_certificate_key</span><span class=p>:</span><span class=w> </span><span class=l>/etc/letsencrypt/live/[domain]/privkey.pem </span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li></ol><h4 id=配置-nginx-反代>配置 NGINX 反代</h4><p>开始后续步骤前确保 80,443 端口空闲且 NGINX 服务处于未激活状态</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 查看 80 端口占用</span>
</span></span><span class=line><span class=cl>lsof -i:80
</span></span><span class=line><span class=cl><span class=c1># 查看 443 端口占用</span>
</span></span><span class=line><span class=cl>lsof -i:443
</span></span><span class=line><span class=cl><span class=c1># 关闭 NGINX 服务</span>
</span></span><span class=line><span class=cl>sudo systemctl stop nginx
</span></span><span class=line><span class=cl><span class=c1># 杀死占用 80/443 端口的游离进程</span>
</span></span><span class=line><span class=cl><span class=nb>kill</span> -9 <span class=o>[</span>PID<span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><ol><li><p>编排 NGINX 配置，在 <code>http</code> 配置组中添加如下 <code>server</code> 代理规则，修改 <code>server_name</code>、<code>ssl_certificate</code> 以及 <code>ssl_certificate_key</code> 字段，其他配置不动。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nginx data-lang=nginx><span class=line><span class=cl><span class=k>server</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kn>listen</span> <span class=mi>443</span> <span class=s>ssl</span> <span class=s>http2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>listen</span> <span class=s>[::]:443</span> <span class=s>ssl</span> <span class=s>http2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>listen</span> <span class=mi>80</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 修改为你的 CDN 域名
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>server_name</span> <span class=s>DOMAIN</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 修改证书路径
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>ssl_certificate</span> <span class=s>/etc/letsencrypt/live/DOMAIN/fullchain.pem</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>ssl_certificate_key</span> <span class=s>/etc/letsencrypt/live/DOMAIN/privkey.pem</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kn>location</span> <span class=s>/</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_pass</span> <span class=s>http://127.0.0.1:8008</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_set_header</span> <span class=s>Host</span> <span class=nv>$http_host</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_set_header</span> <span class=s>Upgrade</span> <span class=nv>$http_upgrade</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=kn>location</span> <span class=p>~</span> <span class=sr>^/(ws|terminal/.+)$</span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_pass</span> <span class=s>http://127.0.0.1:8008</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_http_version</span> <span class=mi>1</span><span class=s>.1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_set_header</span> <span class=s>Upgrade</span> <span class=nv>$http_upgrade</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_set_header</span> <span class=s>Connection</span> <span class=s>&#34;Upgrade&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>proxy_set_header</span> <span class=s>Host</span> <span class=nv>$http_host</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>检查 NGINX 配置文件是否配置正确</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>nginx -t
</span></span></code></pre></td></tr></table></div></div></li><li><p>重启 NGINX，读入新的配置</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo systemctl start nginx
</span></span></code></pre></td></tr></table></div></div></li><li><p>检查 NGINX 运行状态</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo systemctl status nginx
</span></span></code></pre></td></tr></table></div></div></li></ol><p>NGINX 启动后，访问 HTTPS 架构的面板 CDN 域名，如果一切正常，你将会看到和先前步骤中直接访问 <code>http://ip:8008</code> 一样的面板界面。</p><p>🐞 注意！我们一直在使用「面板 CDN 域名」作指代，但目前为止，我们仍没有为该条 A 纪录开启 <code>Cloudflare CDN</code> 。</p><h4 id=绑定面板服务器域名>绑定面板服务器域名</h4><p>从浏览器里访问面板 CDN 域名，OAuth 登录验证管理员身份，进入后台。填写【设置 &ndash; 未接入CDN的面板服务器域名/IP】顾名思义，填写解析到面板节点的另一条 A 纪录的域名。</p><h3 id=添加被控节点>添加被控节点</h3><p>回到面板的【主机】页面，点击【添加服务器】，根据你的喜好填写名称、服务器分组、排序和备注，这些都是可选项。勾选「对游客隐藏」。</p><p>添加完毕后，点击服务器组件的编辑按钮，在弹出的窗口里找到【<strong>Linux 一键安装</strong>】的命令，复制它。</p><img src=image-20230617233441165.png alt="NeZha Dashboard" style=zoom:80%><div align=center><img src=image-20230617233735311.png alt=image-20230617233735311 style=zoom:50%></div><p>SSH 连上你的被控节点，粘贴并运行一键安装命令。回到 Dashboard 的主页，如果一切正常，你可以看到处于「非离线」状态的被控节点信息。</p><p>重复这个操作，<strong>面板添加配置 → 复制指令 → 在被控节点中运行指令</strong> → 添加成功。</p><h3 id=enable-cdn>Enable CDN</h3><p>返回 Cloudflare DNS 配置页面，点击面板 CDN 域名的那条记录旁边的“小云朵”图标。等待 CDN 配置生效，时间短则十几秒，时间长则十几分钟。在此期间，您可以通过“隐私模式”标签页访问 CDN 域名，或在本地 ping CDN 域名，总之就是等。</p><img src=image-20230617234443457.png alt=image-20230617234443457 style=zoom:80%><h2 id=result>Result</h2><p>有关 Get started 的迷思和执行细节可以参考下文的「Advanced」部分。本文还未提及 NeZha Monitoring 的一些高级特性和服务组件，你可以逐步精进，详见 <strong><a class=link href=https://nezha.wiki/guide/services.html target=_blank rel=noopener>官方文档</a></strong>。</p><h2 id=advanced>Advanced</h2><h3 id=哪吒监控基本概念与叙事结构>哪吒监控基本概念与叙事结构</h3><p>NeZha Monitoring 主要由两个部分组成：面板节点和被控节点。任何服务器都可以同时作为面板和被控节点，可以在服务器 A 上部署面板，以展示包括节点 A 在内的多个被控节点的资源状态。</p><p>以下是相关的基础概念：</p><ol><li>面板节点（Dashboard Node）：用于展示被控节点的资源状态。</li><li>被控节点（Agent Node）：定期向面板节点传输本机的资源状态。</li><li>资源状态：包括节点的 CPU、内存、网络 I/O 等常见资源信息。默认情况下，每两秒更新并推送一次。</li></ol><p>通常情况下，我们只需要在几台服务器中选择一台用于部署监控面板。同时，我们需要注意以下几点：</p><ol><li><strong>VPS / EC2 实例</strong>，只有单个 IPv4 的云服务器实例。这些实例由庞大的独立服务器集群虚拟化并分割出来。如果您直接管理多台物理机，那么 NeZha 不适合用作资源探针。</li><li><strong>若干台服务器</strong>，数量 10 或以内的云服务器实例（低配小鸡）。如果您管理的实例超过这个规模且节点之间有非常明显的协同关系，或是管理的实例数量破百甚至达到数万百万的级别，大佬您可以选择一些成熟的 k8s 企业级应用。</li></ol><h3 id=访问权限与授权等相关问题>访问权限与授权等相关问题</h3><p><strong>NeZha Monitoring 通过 OAuth2.0 识别 admin 并给予其（管理后台）和（所有被控节点）的访问权限。</strong></p><p>在本文速通攻略中我们使用 GitHub 作为授权服务器，此外还可以将 GitLab、JihuLab 以及 Gitee 作为授权方（v0.15.1）。</p><p>对于首次使用 NeZha Monitoring 且对 OAuth2.0 比较陌生的玩家可能会有以下一系列的迷思：</p><blockquote><p>Q: 是不是所有人都可以访问我的 NeZha 面板？</p></blockquote><p>A: 对，在浏览器输入网址就可以访问前端面板。只要你的域名到 NeZha service 之间的通路正常，任何人访问面板域名都可以看到 Dashboard font-page。</p><blockquote><p>Q: 那是不是意味着所有人都可以访问后台？</p></blockquote><p>A：当然不，只有注册到 NeZha 面板的管理员用户才能访问后台。</p><blockquote><p>Q: 那么 NeZha 如何区分哪些用户是管理员呢？</p></blockquote><p>A: 细说，这个一句话讲不清楚！</p><p>首先，我们需要定义「游客用户」和「管理员用户」两种角色。</p><ol><li><strong>游客</strong>：直接访问面板且还未登录的用户。</li><li><strong>管理员</strong>：已被添加到面板的 Admin List 中的用户。</li></ol><p>这里的 OAuth2.0 授权过程可以认为是 NeZha 向 GitHub 要了你的 username ，也即，前文我们所说的“授权”，其实指的是你允许 NeZha 获取你 GitHub 账号的数据。在这里，NeZha 只获取了你的 user-data，这包含了你的 GitHub username。</p><p>获取到你的 username 之后，NeZha 就可以比对你的 username 和注册到 Admin List 的 username，区分你是「游客」还是「管理员」。 当然，GitHub username 是唯一的，这里不会出现“重名”的情况。</p><p>值得一提的是，NeZha 没有用户分级机制，也即，你要么是游客要么是管理员，不存在一个“普通用户”的中间态说法。</p><blockquote><p>Q: 那我明白了，回到最初的那个问题，既然「所有人都可以访问我部署的面板」，那是不是意味着这些「游客」都可以看到我的被控节点状态？</p></blockquote><p>A: 你这后半句有歧义啊，<strong>NeZha 没有设计特权机制（Privilege）</strong>，所以没有“这些游客”或是“部分游客”的说法，也即，<strong>对于某个被控节点来说，要么所有的游客都可以看到它的资源状态，要么所有的游客都不行</strong>。</p><p>如果你走过前文的速通攻略，你会发现在添加被控节点的时候有个 「对游客隐藏」的选项，如果勾选了，那么这个节点在我们直接访问站点且还未“以管理员身份登录”的情况下是不可见的。</p><p>上文说到 NeZha 没有用户分级机制，你要么是游客要么是管理员，<strong>NeZha 会阻止非管理员用户访问「对游客隐藏」的被控节点</strong>。</p><p>换句话说，在你授权 NeZha 获取到你的 username 之后，会发生以下两种情况：</p><ol><li>你是管理员，开放管理后台和所有被控节点的访问权限</li><li>你是不是管理员，要么看到“空白页”，要么能看到「没有对游客隐藏」的被控节点的资源状态</li></ol><p>也即，如果你已经意识到你没有该 NeZha 站点的管理员账号，你可以提前对自己说「我就来看看」。</p><h2 id=reference>Reference</h2><ul><li><p><a class=link href=https://nezha.wiki/index.html target=_blank rel=noopener>NeZha Documentation</a></p></li><li><p><a class=link href=https://github.com/naiba/nezha target=_blank rel=noopener>NeZha GitHub repository</a></p></li></ul></section><footer class=article-footer><section class=article-tags><a href=/tags/nezha/>NeZha</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title></h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/p/dive-into-clash-dns/><div class=article-image><img src=/p/dive-into-clash-dns/dominik-mayer.e6113b3dec3fa29b6e465ea27e9e1c15_hu5839e53c54117c6791a00e83defa26e6_1229585_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post 『Blog』Dive into Clash DNS" data-key=dive-into-clash-dns data-hash="md5-5hE7Pew/optuRl6ifp4cFQ=="></div><div class=article-details><h2 class=article-title>『Blog』Dive into Clash DNS</h2></div></a></article><article class=has-image><a href=/p/mouting-alidrive-locally/><div class=article-image><img src=/p/mouting-alidrive-locally/doharge-08.27fe05f80783b2afc1a99ae30afbef9a_hu13fdd9666faf8189fe2265e8a87a6e60_2048497_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post 『Blog』Mounting Alidrive Locally" data-key=mouting-alidrive-locally data-hash="md5-J/4F+AeDsq/BqZrjCvvvmg=="></div><div class=article-details><h2 class=article-title>『Blog』Mounting Alidrive Locally</h2></div></a></article><article class=has-image><a href=/p/google-research-seanet-musiclm/><div class=article-image><img src=/p/google-research-seanet-musiclm/lixin.6532f3b9036b287abd9baa6e6ffbf0f7_hu108383160588985e40f4f4076326a6a7_370693_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post 『Blog』AI 有望成为华语乐坛的下一任周杰伦" data-key=google-research-seanet-musiclm data-hash="md5-ZTLzuQNrKHq9m6pub/vw9w=="></div><div class=article-details><h2 class=article-title>『Blog』AI 有望成为华语乐坛的下一任周杰伦</h2></div></a></article><article class=has-image><a href=/p/chatgpt-antirules/><div class=article-image><img src=/p/chatgpt-antirules/naifan-zhang-4.0c5815704d7dbbc2bfe51f3c0db101fe_hu3e631bccb1a1bbdefca010a85222fc9f_376773_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post 『Blog』ChatGPT Anti Rules" data-key=chatgpt-antirules data-hash="md5-DFgVcE19u8K/5R88DbEB/g=="></div><div class=article-details><h2 class=article-title>『Blog』ChatGPT Anti Rules</h2></div></a></article><article class=has-image><a href=/p/chatgpt-register/><div class=article-image><img src=/p/chatgpt-register/lixin.23c0d1f4ab1eeefa1421bfb4ab576d11_hub61807a84e13a72e03127d9d91db1097_437671_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post 『Blog』跳出传统，ChatGPT 带你玩转智能对话" data-key=chatgpt-register data-hash="md5-I8DR9Kse7voUIb+0q1dtEQ=="></div><div class=article-details><h2 class=article-title>『Blog』跳出传统，ChatGPT 带你玩转智能对话</h2></div></a></article></div></div></aside><script src=https://utteranc.es/client.js repo=qin2dim/blog-comments issue-term=pathname crossorigin=anonymous async></script><style>.utterances{max-width:unset}</style><script>function setUtterancesTheme(e){let t=document.querySelector(".utterances iframe");t&&t.contentWindow.postMessage({type:"set-theme",theme:`github-${e}`},"https://utteranc.es")}addEventListener("message",e=>{if(e.origin!=="https://utteranc.es")return;setUtterancesTheme(document.documentElement.dataset.scheme)}),window.addEventListener("onColorSchemeChange",e=>{setUtterancesTheme(e.detail)})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2023 Echosec @QIN2DIM</section><section class=powerby>You will to enjoy grander sight / By climing to a greater height.<br>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.12.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#preview>Preview</a><ol><li><a href=#简介>简介</a></li><li><a href=#先决条件>先决条件</a></li></ol></li><li><a href=#get-started>Get started</a><ol><li><a href=#setup>Setup</a></li><li><a href=#github-oauth20-应用申请>GitHub OAuth2.0 应用申请</a></li><li><a href=#拉起面板节点>拉起面板节点</a></li><li><a href=#配置面板节点>配置面板节点</a><ol><li><a href=#申请证书>申请证书</a></li><li><a href=#配置-nginx-反代>配置 NGINX 反代</a></li><li><a href=#绑定面板服务器域名>绑定面板服务器域名</a></li></ol></li><li><a href=#添加被控节点>添加被控节点</a></li><li><a href=#enable-cdn>Enable CDN</a></li></ol></li><li><a href=#result>Result</a></li><li><a href=#advanced>Advanced</a><ol><li><a href=#哪吒监控基本概念与叙事结构>哪吒监控基本概念与叙事结构</a></li><li><a href=#访问权限与授权等相关问题>访问权限与授权等相关问题</a></li></ol></li><li><a href=#reference>Reference</a></li></ol></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>