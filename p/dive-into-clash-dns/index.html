<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="深入浅出地介绍 Clash DNS 的工作原理"><title>『Blog』Dive into Clash DNS</title><link rel=canonical href=https://blog.echosec.top/p/dive-into-clash-dns/><link rel=stylesheet href=/scss/style.min.00066413cf5b11ff83f68f901cd98368c0b2d6327b373ddf957666a5c4d92db2.css><meta property="og:title" content="『Blog』Dive into Clash DNS"><meta property="og:description" content="深入浅出地介绍 Clash DNS 的工作原理"><meta property="og:url" content="https://blog.echosec.top/p/dive-into-clash-dns/"><meta property="og:site_name" content="Echosec @QIN2DIM"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="clash"><meta property="article:tag" content="clash-meta"><meta property="article:tag" content="clash-verge"><meta property="article:tag" content="clash-dns"><meta property="article:tag" content="dns-router"><meta property="article:tag" content="fakeip"><meta property="article:tag" content="fakedns"><meta property="article:published_time" content="2023-07-15T12:17:57+08:00"><meta property="article:modified_time" content="2023-07-15T12:17:57+08:00"><meta property="og:image" content="https://blog.echosec.top/p/dive-into-clash-dns/dominik-mayer.jpg"><meta name=twitter:site content="@Alkaid20860233"><meta name=twitter:creator content="@Alkaid20860233"><meta name=twitter:title content="『Blog』Dive into Clash DNS"><meta name=twitter:description content="深入浅出地介绍 Clash DNS 的工作原理"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.echosec.top/p/dive-into-clash-dns/dominik-mayer.jpg"><link rel="shortcut icon" href=https://cdn.jsdelivr.net/gh/qin2dim/cdn-relay@main/avatars/watercolour-4817390__480.jpg><script async src="https://www.googletagmanager.com/gtag/js?id=G-9XVBFK3RRV"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-9XVBFK3RRV",{anonymize_ip:!1})}</script><link rel=stylesheet href=//cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css><script async src=https://busuanzi.icodeq.com/busuanzi.pure.mini.js></script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"light")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/62018067_hu01b1850304f2a433574ed2470395348a_321911_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a>
<span class=emoji>🎯</span></figure><div class=site-meta><h1 class=site-name><a href=/>Echosec @QIN2DIM</a></h1><h2 class=site-description>A Creator from China.</h2></div></header><ol class=social-menu><li><a href=https://github.com/QIN2DIM target=_blank title=GitHub><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com/Tk206_ target=_blank title=Twitter><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li><li><a href=https://nav.echosec.top target=_blank title=Navigator><!doctype html><svg t="1635028836276" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="9207" width="128" height="128" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><style/></defs><path d="M782.802 129.086c3.079.0 5.884 2.805 5.884 5.884v744.58L561.591 601.177 512 540.387l-49.591 60.789-227.095 278.375v-744.58c0-3.08 2.805-5.884 5.884-5.884h541.604m0-64.001H241.198c-38.436.0-69.884 31.448-69.884 69.884v768.729c.276 33.712 27.781 55.214 56.065 55.214 15.368.0 30.969-6.353 42.548-20.546L512 641.633 753.023 937.08c11.68 14.317 27.793 20.773 43.661 20.773 28.115.0 55.458-20.27 55.993-53.003.006-.383.009-.767.009-1.151V134.971c0-38.437-31.447-69.885-69.884-69.885z" p-id="9208" fill="#bababa"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/links><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg><span>Links</span></a></li><li><a href=/archives><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>暗色模式</span></li></div></ol></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/dive-into-clash-dns/><img src=/p/dive-into-clash-dns/dominik-mayer_hu5839e53c54117c6791a00e83defa26e6_1229585_800x0_resize_q75_box.jpg srcset="/p/dive-into-clash-dns/dominik-mayer_hu5839e53c54117c6791a00e83defa26e6_1229585_800x0_resize_q75_box.jpg 800w, /p/dive-into-clash-dns/dominik-mayer_hu5839e53c54117c6791a00e83defa26e6_1229585_1600x0_resize_q75_box.jpg 1600w" width=800 height=497 loading=lazy alt="Featured image of post 『Blog』Dive into Clash DNS"></a></div><div class=article-details><header class=article-category><a href=/categories/software-engineering/ style=background-color:#cfb887;color:#fff>Software Engineering</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/dive-into-clash-dns/>『Blog』Dive into Clash DNS</a></h2><h3 class=article-subtitle>深入浅出地介绍 Clash DNS 的工作原理</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>2023-07-15</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>阅读时长: 21 分钟</time></div></footer></div></header><section class=article-content><h2 id=简介>简介</h2><p>逐行阅读源码，超！硬！核！的 Clash DNS 底层原理详解！</p><p>（incoming&mldr;）</p><h2 id=实验环境>实验环境</h2><div class=table-wrapper><table><thead><tr><th style=text-align:left>操作系统</th><th style=text-align:left>Windows 11</th></tr></thead><tbody><tr><td style=text-align:left>系统DNS</td><td style=text-align:left>192.168.31.1</td></tr><tr><td style=text-align:left>网关IP</td><td style=text-align:left>192.168.31.1</td></tr><tr><td style=text-align:left>子网IP</td><td style=text-align:left>192.168.31.178</td></tr><tr><td style=text-align:left>代理核心</td><td style=text-align:left><a class=link href=https://github.com/MetaCubeX/Clash.Meta/releases/tag/v1.15.0 target=_blank rel=noopener>Clash.Meta v1.15.0</a></td></tr><tr><td style=text-align:left>引导UI</td><td style=text-align:left><a class=link href=https://github.com/zzzgydi/clash-verge/releases/tag/v1.3.3 target=_blank rel=noopener>clash-verge v1.3.3</a></td></tr></tbody></table></div><ol><li><p>Protocol: tuic v5</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>proxies</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- {<span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;tunic&#34;</span><span class=nt>, type: tuic, udp-relay-mode: quic, congestion-controller: bbr, alpn: [&#39;h3&#39;, &#39;spdy/3.1&#39;], reduce-rtt: True, max-udp-relay-packet-size: 1464, server: *, port: *, uuid: *, password: *, ip</span><span class=p>:</span><span class=w> </span>*<span class=w> </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>proxy-groups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- {<span class=w> </span><span class=nt>name: PROXY, type: select, proxies</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;tunic&#34;</span><span class=p>]</span><span class=w> </span>}<span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>RULE-SET 来自规则上游 <em>Loyalsoldier/clash-rules</em></p><p>当正文中没有明确说明 rules 时使用如下配置：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>rule-providers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># -- skip --</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>RULE-SET,applications,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>GEOSITE,cn,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>GEOSITE,private,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>DOMAIN,clash.razord.top,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>DOMAIN,yacd.haishan.me,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>DOMAIN,services.googleapis.cn,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>RULE-SET,reject,REJECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>RULE-SET,direct,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>RULE-SET,private,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>RULE-SET,proxy,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>RULE-SET,icloud,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>RULE-SET,apple,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>RULE-SET,lancidr,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>RULE-SET,cncidr,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>RULE-SET,telegramcidr,PROXY,no-resolve</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>GEOIP,PRIVATE,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>GEOIP,CN,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>MATCH,PROXY</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li></ol><h2 id=实验方法>实验方法</h2><blockquote><p>🦉实验可安全复现</p></blockquote><ol><li><p>分别在规则模式，全局模式，直连模式下使用预定义的 <code>dns</code> 实验配置访问域名：</p><ul><li><p><code>api.dida365.com</code></p><p>命中规则 <code>geosite:cn</code></p></li><li><p><code>api.dida36768990.com</code></p><p>一个随便敲的域名，假设它不存在。显然，这是个不存在于各个 RULE-SET 中的 target。</p></li><li><p><code>www.google.com</code></p><p>从上至下，命中首条域名代理规则。</p></li></ul></li><li><p>切换到 TUN 模式再测一遍</p></li><li><p>Recode DNS configuration, logger, wireshark trace</p><p>记录请求的触发顺序，阐述 clash DNS 通信的底层逻辑。</p></li><li><p>无特殊说明统一使用 clash 代称 Clash 和 Clash.Meta</p></li><li><p>实验在 Win PC 执行，而非软路由等嵌入式设备</p></li><li><p>每轮实验结束后清除所有 clash 连接， <code>ipconfig \flushdns</code> 清除 DNS 缓存</p></li><li><p>实验中使用 clash-verge 引导 Clash.Meta 代理核心，UI 保持出厂设定</p></li></ol><hr><blockquote><p>🪖需要注意：Clash DNS Object 有初始值，clash 会用硬编码的初始化参数覆盖我们缺省的字段，具体默认值可看上文的 <a class=link href>DNS 默认配置</a> 以及 <a class=link href>UnmarshalRawConfig</a>。</p></blockquote><p>实验按以下模块依次行进：</p><ol><li>config.yaml 中的 dns 配置字段</li><li>wireshark 抓包，过滤条件是 <code>dns && ip.dst==192.168.31.178</code></li><li>连接日志（可省略）</li></ol><h2 id=配置篇>配置篇</h2><h3 id=引入-default-nameserver--nameserver>引入 default-nameserver & nameserver</h3><blockquote><p>💡前者用于解析后者的域名，后者用于解析我们要访问的域名。</p></blockquote><h4 id=规则模式---对照组--默认配置>规则模式 - 对照组 | 默认配置</h4><p>仅设置 <em>enable</em> 字段，此时采用<a class=link href="https://www.notion.so/Dive-into-Clash-DNS-a025c9bb5f724972a2ffb7984ae4a6ca?pvs=21" target=_blank rel=noopener>初始化的 DNS 配置</a>。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>dns</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enable</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>可以看到，核心先并发请求 default-nameserver 中配置的四条 DNS IP 去解析 <code>doh.pub</code> （再使用 <code>https://doh.pub/dns-query</code> 这条 DOH <em>nameserver</em> 配置去解析 <code>api.dida365.com</code>）。</p><p>DOH 行进时，域名查询被封装在 HTTPS 请求中，使其本质上成为了 HTTP 协议类型的加密流量。这种类型的请求无法使用 protocol==dns 进行捕获，如 wireshark 的截图所示，看不到查询 <code>api.dida365.com</code> 的响应纪录。</p><p><img src=/p/dive-into-clash-dns/image-20230715192020922.png width=1460 height=193 srcset="/p/dive-into-clash-dns/image-20230715192020922_hu89b0e13e4d05c57b691796638e3491eb_142888_480x0_resize_box_3.png 480w, /p/dive-into-clash-dns/image-20230715192020922_hu89b0e13e4d05c57b691796638e3491eb_142888_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=756 data-flex-basis=1815px></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>TCP<span class=o>]</span> 127.0.0.1:64007<span class=o>(</span>msedge.exe<span class=o>)</span> --&gt; api.dida365.com:443 match GeoSite<span class=o>(</span>cn<span class=o>)</span> using DIRECT
</span></span></code></pre></td></tr></table></div></div><p>可以得出如下阶段性结论：</p><ol><li><p><strong>访问域名时遇到直连域名规则，从本地发起 DNS 请求</strong></p><p><code>api.dida365.com</code> 是一个在 <code>geosite:cn</code> 数据库中的规则，其对应了我们的出站策略 <strong>DIRECT</strong>（详见上文的 rules），也即，下面这两种情况是等价的。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>GEOSITE,CN,DIRECT</span><span class=w> </span><span class=c># A</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>DOMAIN,api.dida365.com,DIRECT</span><span class=w> </span><span class=c># B</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p><strong><em>default-nameserver</em> 仅用来解析 <em>nameserver</em> 字段中配置的域名</strong></p><p>这也说明了 <em>default-nameserver</em> 为什么只能写 IP 而不能写域名，这会遇到先有鸡还是先有蛋的问题。但值得一提的是，<em>default-nameserver</em> 支持 HTTPS 写法。</p><p>这也意味着，如果 <em>nameserver</em> 中没有配置域名形式的 <em>DOH/DOT/DOQ</em>，则 <em>default-nameserver</em> 对应的业务代码不会被触发。（具体情况看下文的测试）</p></li><li><p><strong>通过 <em>nameserver</em> 解析我们要访问的域名</strong></p></li></ol><h4 id=规则模式---仅设置-nameserver-为-dns-ip>规则模式 - 仅设置 <em>nameserver</em> 为 DNS IP</h4><blockquote><p>从这里开始我们就不贴规则匹配的日志了，结果都和对照组一样。我们在仅修改 DNS 配置的情况下，同一 target 的出站策略不受影响。</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>dns</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enable</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nameserver</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=m>223.5.5.5</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>行进步骤如下：</p><ol><li><p>浏览器访问 <code>api.dida365.com</code> ，请求通过系统代理进入 clash</p></li><li><p>使用 <em>nameserver</em> 解析我们要访问的域名</p><p>可以看到我们向（人为配置的）223.5.5.5 发起了明文 DNS 请求并收到了查询响应。其中，除了我们访问的 <code>api.dida365.com</code> ，还能看到其他驻台程序发起的 DNS 请求。</p><p>显然，这与对照组的结果不一致。</p><p>具体来说 ，我们在对照组（默认配置）下使用 DOH <a class=link href=https://doh.pub/dns-query target=_blank rel=noopener>https://doh.pub/dns-query</a> 发送域名解析请求，这个请求是一个封装在 HTTPS 数据包中的加密申请，我们无法在过滤条件为 <code>dns</code> 的筛选中捕获到这条解析请求。而本组实验设置中使用了未经加密的申请，也即 <strong>udp://223.5.5.5:53</strong>（行进源码自动补全为 URL），这是一条命中 <code>dns</code> 过滤规则的请求，我们不仅可以捕获到它，还能看见它的 Message/Information，即，要访问/要解析的站点。</p></li><li><p>由于<strong>我们未配置域名形式的 DOH</strong>，所以 <em>default-nameserver</em> 相关行进代码未被触发。</p></li></ol><p><img src=/p/dive-into-clash-dns/image-20230715192539131.png width=1460 height=136 srcset="/p/dive-into-clash-dns/image-20230715192539131_hu46dbbc8a5173a5abc7d300ae0aea994b_116519_480x0_resize_box_3.png 480w, /p/dive-into-clash-dns/image-20230715192539131_hu46dbbc8a5173a5abc7d300ae0aea994b_116519_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=1073 data-flex-basis=2576px></p><h4 id=规则模式---仅设置-nameserver-为-doh-ip>规则模式 - 仅设置 <em>nameserver</em> 为 DOH: IP</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>dns</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enable</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nameserver</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>https://223.5.5.5/dns-query</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>行进步骤如下：</p><ol><li><p>浏览器访问 <code>api.dida365.com</code> ，请求通过系统代理进入 clash</p></li><li><p>使用 <em>nameserver</em> 解析我们要访问的域名</p><p>我们向 IP 形式的 DOH 发起了对 <code>api.dida365.com</code> 域名解析请求，请求被加密到 HTTPS 数据包中，通过 dns 筛选无法捕获。</p></li><li><p>由于<strong>我们未配置域名形式的 DOH</strong>，所以 <em>default-nameserver</em> 相关行进代码未被触发。</p><p><img src=/p/dive-into-clash-dns/image-20230715192605396.png width=1460 height=112 srcset="/p/dive-into-clash-dns/image-20230715192605396_huc4d0330bb6469d0aba90b1a0f2013393_18988_480x0_resize_box_3.png 480w, /p/dive-into-clash-dns/image-20230715192605396_huc4d0330bb6469d0aba90b1a0f2013393_18988_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=1303 data-flex-basis=3128px></p></li><li><p>当我们等待一段时间后，我们可以陆续收到来自系统DNS（网关）返回的 DNS 查询响应。按理说，我们的请求不是被加密了吗？要响应也应该是 HTTPS 类型的协议，再不济也应该是阿里服务器返回的响应啊？（也即 <code>dns && ip.src==223.5.5.5</code>）怎么会有来自本地运营商发来的 DNS 查询响应呢？</p><p>这涉及到 Windows 操作系统级的 DNS 查询组策略，我们后文细说。</p><p><img src=/p/dive-into-clash-dns/image-20230715192620101.png width=1460 height=153 srcset="/p/dive-into-clash-dns/image-20230715192620101_hu0f3f6089e9ff7f8c928d1d3e58376b90_177260_480x0_resize_box_3.png 480w, /p/dive-into-clash-dns/image-20230715192620101_hu0f3f6089e9ff7f8c928d1d3e58376b90_177260_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=954 data-flex-basis=2290px></p></li></ol><h4 id=规则模式---仅设置-nameserver-为-doh-domain>规则模式 - 仅设置 <em>nameserver</em> 为 DOH: domain</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>dns</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enable</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nameserver</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>https://dns.alidns.com/dns-query</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>是不是熟悉的感觉又回来了~🐧</p><p>行进步骤如下：</p><ol><li><p>浏览器访问 <code>api.dida365.com</code> ，请求通过系统代理进入 clash</p></li><li><p>使用 <em>nameserver</em> 解析我们要访问的域名</p><p>与对照组的情况一直，这是个加密请求，后文不再赘述。</p></li><li><p><strong>我们配置了域名形式的 DOH</strong>，<em>default-nameserver</em> 相关代码开始执行。</p></li></ol><p><img src=/p/dive-into-clash-dns/image-20230715192644224.png width=1460 height=195 srcset="/p/dive-into-clash-dns/image-20230715192644224_huc93d893886078e68ba7f92e3db185b57_261789_480x0_resize_box_3.png 480w, /p/dive-into-clash-dns/image-20230715192644224_huc93d893886078e68ba7f92e3db185b57_261789_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=748 data-flex-basis=1796px></p><h3 id=引入-namesever-policy>引入 namesever-policy</h3><blockquote><p>💡优先级高于 <em>nameserver</em></p></blockquote><h4 id=规则模式---同时设置-nameserver-policy-和-nameserver>规则模式 - 同时设置 <em>nameserver-policy</em> 和 <em>nameserver</em></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>dns</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enable</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nameserver</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=m>223.5.5.5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nameserver-policy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s2>&#34;api.dida365.com&#34;</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>1.0.0.1</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ol><li><p>浏览器访问 <code>api.dida365.com</code> ，请求通过系统代理进入 clash</p></li><li><p>命中规则，使用 <em>nameserver-policy</em> 解析域名 <code>api.dida365.com</code></p><p>当我们访问 <code>api.dida365.com</code> 时优先使用 1.0.0.1 进行域名解析。除此之外所有的 DNS 请求都走 223.5.5.5，比如随后响应的<code>cdn.dida365.com</code>。</p></li><li><p>由于 <em>nameserver</em> 和 <em>nameserver-policy</em> 都不存在域名形式的 DOH，<em>default-nameserver</em> 相关代码不启动</p></li></ol><p><img src=/p/dive-into-clash-dns/image-20230715192921676.png width=1460 height=310 srcset="/p/dive-into-clash-dns/image-20230715192921676_hua0bab46442daaaf97a1159327dd136a8_462319_480x0_resize_box_3.png 480w, /p/dive-into-clash-dns/image-20230715192921676_hua0bab46442daaaf97a1159327dd136a8_462319_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=470 data-flex-basis=1130px></p><h4 id=规则模式---混用-doh>规则模式 - 混用 DOH</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>dns</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enable</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nameserver</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=m>119.29.29.29</span><span class=w> </span><span class=c># 腾讯 IPv4 DNS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nameserver-policy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s2>&#34;api.dida365.com&#34;</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>https://dns.alidns.com/dns-query</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>一路看到这你应该能自己总结行进步骤了~🐧</p><ol><li><p>浏览器访问 <code>api.dida365.com</code> ，请求通过系统代理进入 clash</p></li><li><p>命中规则，使用 <em>nameserver-policy</em> 解析域名 <code>api.dida365.com</code></p><p><em>nameserver-policy</em> 优先生效，里面有域名形式的 DOH，<em>default-nameserver</em> 启动 ；解析 <code>api.dida365.com</code> 的 DNS 请求被加密成 HTTPS，在 dns 筛选中不显示。</p><p>除此之外所有的 DNS 请求都走 119.29.29.29，比如随后响应的<code>cdn.dida365.com</code>。<em>nameserver</em> 中没有域名形式的 DOH，<em>default-nameserver</em> 不启动。</p></li></ol><p><img src=/p/dive-into-clash-dns/image-20230715192944128.png width=1460 height=201 srcset="/p/dive-into-clash-dns/image-20230715192944128_hue5f237253565dcb1eae698991c88faed_259286_480x0_resize_box_3.png 480w, /p/dive-into-clash-dns/image-20230715192944128_hue5f237253565dcb1eae698991c88faed_259286_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=726 data-flex-basis=1743px></p><h4 id=规则模式---仅设置-nameserver-policy-为-doh-ip>规则模式 - 仅设置 <em>nameserver-policy</em> 为 DOH: IP</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>dns</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enable</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nameserver-policy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s2>&#34;api.dida365.com&#34;</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>https://223.5.5.5/dns-query</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ol><li><p>浏览器访问 <code>api.dida365.com</code> ，请求通过系统代理进入 clash</p></li><li><p>命中规则，使用 <em>nameserver-policy</em> 解析域名 <code>api.dida365.com</code></p><p><em>nameserver-policy</em> 生效，里面没有域名形式的 DOH，<em>default-nameserver</em> 不启动 ；解析 <code>api.dida365.com</code> 的 DNS 请求被加密成 HTTPS，在 dns 筛选中不显示。</p><p>其他的 DNS 请求都走 <em>nameserver</em> ,也即默认值 <code>https://doh.pub/dns-query</code> ，这是一条域名形式的 DOH，<em>default-nameserver</em> 启动。</p><p>显然，走 DOH 的 DNS 请求被加密，在 wireshark 结果中看不到 target 响应</p></li></ol><p><img src=/p/dive-into-clash-dns/image-20230715193000271.png width=1460 height=179 srcset="/p/dive-into-clash-dns/image-20230715193000271_hua540d46dbc336b4d471f80e0f323031e_217105_480x0_resize_box_3.png 480w, /p/dive-into-clash-dns/image-20230715193000271_hua540d46dbc336b4d471f80e0f323031e_217105_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=815 data-flex-basis=1957px></p><h4 id=规则模式---仅设置-nameserver-policy-为-doh-domain>规则模式 - 仅设置 <em>nameserver-policy</em> 为 DOH: domain</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>dns</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enable</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nameserver-policy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s2>&#34;api.dida365.com&#34;</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>https://dns.alidns.com/dns-query</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ol><li><p>浏览器访问 <code>api.dida365.com</code> ，请求通过系统代理进入 clash</p></li><li><p>命中规则，使用 <em>nameserver-policy</em> 解析域名 <code>api.dida365.com</code></p><p><em>nameserver-policy</em> 生效，里面有域名形式的 DOH，<em>default-nameserver</em> 启动 ；解析 <code>api.dida365.com</code> 的 DNS 请求被加密成 HTTPS，在 dns 筛选中不显示。</p><p>其他的 DNS 请求都走 <em>nameserver</em> ,结果同上一则实验一致。</p></li></ol><p><img src=/p/dive-into-clash-dns/image-20230715193019120.png width=1460 height=409 srcset="/p/dive-into-clash-dns/image-20230715193019120_huc1e892ccf6da88c04cbcd53b7caa8e67_512936_480x0_resize_box_3.png 480w, /p/dive-into-clash-dns/image-20230715193019120_huc1e892ccf6da88c04cbcd53b7caa8e67_512936_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=356 data-flex-basis=856px></p><h3 id=引入-dns-分流>引入 DNS 分流</h3><blockquote><p>💡你如果是一个 Clash 骨灰级玩家或是项目的核心贡献者，也许有这样的感悟：DNS 是 clash 类项目设计最为精妙也是最复杂的机制，甚至没有之一。</p></blockquote><h4 id=规则模式---域名规则的解析>规则模式 - 域名规则的解析</h4><p>添加出站规则，将 <code>api.dida365.com</code> 设为 <em>#PROXY</em> 出站：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c># 在对照规则之前该条添加规则</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span>- <span class=l>DOMAIN,api.dida365.com,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c># -- skip  --</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span>- <span class=l>MATCH,PROXY</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>使用 8.8.8.8 标记 <code>api.dida365.com</code> ，使用 223.5.5.5 标记其他请求：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>dns</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enable</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nameserver</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>https://dns.alidns.com/dns-query</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=m>223.5.5.5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nameserver-policy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s2>&#34;api.dida365.com&#34;</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>https://dns.google/dns-query</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>8.8.8.8</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>在开始该组实验前，我们可以根据上文实验结果提出如下假设：</p><p><strong>&lt;A></strong> ✅ 如果浏览器向 <code>api.dida365.com</code> 发出请求，必然触发 <em>nameserver-policy</em> 的域名解析任务；<em>nameserver-policy</em> 内有域名形式的DOH，必然会使用 <em>default-nameserver</em>（并发）解析 <code>dns.google</code> ，最后使用解析到的 DOH IP 和 8.8.8.8 （并发）解析 <code>api.dida365.com</code>。</p><p><strong>&lt;B></strong> ✅ （假设没有发生 IP 规则匹配）其他的域名直连请求使用 <em>nameserver</em> 进行解析，显然 <em>nameserver</em> 组内也有域名形式的 DOH，必然使用 <em>default-nameserver</em> （并发）解析 <code>dns.alidns.com</code> ，使用解析到的 DOH IP 和 223.5.5.5 并发查询我们要访问的域名。</p><p>抓包结果如下图所示（隐去若干条杂质数据）：</p><p><img src=/p/dive-into-clash-dns/image-20230715193212997.png width=1460 height=387 srcset="/p/dive-into-clash-dns/image-20230715193212997_hu5bf5753870fe65ca3599d58c7db4ff4e_489021_480x0_resize_box_3.png 480w, /p/dive-into-clash-dns/image-20230715193212997_hu5bf5753870fe65ca3599d58c7db4ff4e_489021_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=377 data-flex-basis=905px></p><blockquote><p>🏴‍☠️ 我们先在这个组实验中抛出 &lt;DNS泄漏> 的概念，具体内容后文细说。</p></blockquote><p>可以得出如下观察纪录：</p><p>首先，我们能观察到 <em>default-nameserver</em> 开始解析 <code>dns.alidns.com</code> 域名，说明 <em>nameserver</em> 被触发，说明有其他<strong>域名直连请求命中了 DIRECT 域名规则</strong>（假设没有发生 IP 规则匹配）。</p><p>而当我们不间断地请求 <code>api.dida365.com</code> 时，我们为其配置的 <em>nameserver-policy</em> 并未生效，我们在 <strong>&lt;A></strong> 中假象的逻辑链没有发生，也即，clash 并未向 <em>default-nameserver</em> 发起针对 <code>dns.google</code> 的域名解析请求，或者说，本地没有发起对 <code>api.dida365.com</code> 的直连访问请求。</p><p>显然，<strong>我们将 <code>api.dida365.com</code> 设置为 <em>PROXY</em> 出站后，访问目标站点的工作交由远程服务器完成，自然地，域名解析的工作也由远程服务器完成</strong>。本地做的，只是将访问 <code>api.dida365.com</code> 的代理请求呈送至远程服务器，也即，命中 <em>PROXY</em> 域名规则后，clash 会直接跳过 DNS 步骤向远程服务器呈送数据包。</p><h4 id=规则模式---域名规则的解析---验证>规则模式 - 域名规则的解析 - 验证</h4><ul><li><strong>验证 &lt;1></strong></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>dns</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enable</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nameserver</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=m>223.5.5.5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nameserver-policy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s2>&#34;api.dida36768990.com&#34;</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>8.8.8.8</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>DOMAIN,api.dida36768990.com,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># -- skip --</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>MATCH,PROXY</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ol><li><p>浏览器访问 <code>api.dida36768990.com</code>，请求通过系统代理进入 clash</p></li><li><p>命中规则，使用 <em>nameserver-policy</em> 解析域名 <code>api.dida365.com</code></p><p><em>nameserver-policy</em> 生效，里面没有域名形式的 DOH，<em>default-nameserver</em> 不启动，直接使用 8.8.8.8 解析 <code>api.dida36768990.com</code>。</p><p>显然，这是一个不存在的域名，DNS 响应出现 no such name 错误。</p></li></ol><p><img src=/p/dive-into-clash-dns/image-20230715193406460.png width=1460 height=236 srcset="/p/dive-into-clash-dns/image-20230715193406460_hua2a577e573b6e2308569eba0d075462a_349695_480x0_resize_box_3.png 480w, /p/dive-into-clash-dns/image-20230715193406460_hua2a577e573b6e2308569eba0d075462a_349695_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=618 data-flex-basis=1484px></p><ul><li><strong>验证 &lt;2></strong></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>dns</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enable</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nameserver</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=m>223.5.5.5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nameserver-policy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s2>&#34;api.dida36768990.com&#34;</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>8.8.8.8</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c># 在对照组之前添加规则</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span>- <span class=l>DOMAIN,api.dida36768990.com,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span>- <span class=l>DOMAIN,api.dida365.com,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c># -- skip --</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span>- <span class=l>MATCH,PROXY</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li><p><strong>情况1</strong>：浏览器访问 <code>api.dida365.com</code> ，请求通过系统代理进入 clash</p><p>未命中 <em>nameserver-policy</em>，切换至 <em>nameserver</em> ，组内没有域名形式的 DOH，<em>default-nameserver</em> 不启动，直接向 223.5.5.5 发起域名解析请求（绿色记录）。</p><p>其他命中<strong>域名直连规则</strong>的请求也是用 nameserver 进行域名解析（橙色记录）。</p><p>相关 DNS 请求均未被加密，可以看到抓包记录。</p></li><li><p><strong>情况2</strong>：浏览器访问 <code>api.dida36768990.com</code>，请求通过系统代理进入 clash</p><p>命中 <em>nameserver-policy</em>，组内没有域名形式的 DOH，<em>default-nameserver</em> 不启动，直接向 8.8.8.8 发起域名解析请求。显然，这是一个不存在的域名，DNS 响应出现 no such name 错误（黄色记录）。</p></li></ul><p><img src=/p/dive-into-clash-dns/image-20230715193441482.png width=1460 height=317 srcset="/p/dive-into-clash-dns/image-20230715193441482_hu08f23afb31c4c6256fbfcb60c2b38ac3_437478_480x0_resize_box_3.png 480w, /p/dive-into-clash-dns/image-20230715193441482_hu08f23afb31c4c6256fbfcb60c2b38ac3_437478_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=460 data-flex-basis=1105px></p><h4 id=规则模式---ip-规则的解析>规则模式 - IP 规则的解析</h4><p>首先修改出站规则，分别使用 223.5.5.5 和 180.76.76.76 标记 <code>api.dida365.com</code> 和 <code>api.dida36768990.com</code> 其余直连请求使用 119.29.29.29。这里为了 trace 纪录干净整洁便于原理分析，就不使用域名 DOH 了。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>dns</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enable</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nameserver</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=m>119.29.29.29</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nameserver-policy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s2>&#34;api.dida365.com&#34;</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>223.5.5.5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s2>&#34;api.dida36768990.com&#34;</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>180.76.76.76</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>GEOIP,CN,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>DOMAIN,api.dida36768990.com,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>DOMAIN,api.dida365.com,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>MATCH,PROXY</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ol><li><p>浏览器访问 <code>api.dida365.com</code> ，请求通过系统代理进入 clash</p></li><li><p><strong>遇到</strong> <strong>GEOIP 代理规则，发起本地 DNS 查询</strong></p><p>很多小伙们困惑的点就在这了！根据我们上文提到的结论，访问域名时遇到 IP 规则会进行DNS 解析，遇到代理规则会将请求呈送至远程服务器。那这种特殊情况到底是先进行 DNS 解析还是直接将数据包呈送到远程服务器跳过DNS解析呢？</p><p><strong>访问域名时遇到 IP 规则，先进行本地 DNS 解析，将要请求的域名解析成 IP，再与 IP 规则集中的 IP 进行匹配，如果命中，出站规则生效，否则进入下一个规则集。</strong></p><p><strong>访问域名时遇到域名规则，如果是直连出站，则由本地发起 DNS 查询；如果是代理出站，则跳过 DNS 查询并将代理请求呈送至远程服务器。</strong></p></li><li><p>命中规则，使用 <em>namesever-policy</em> 解析域名 <code>api.dida365.com</code></p><p>如下图所示，本地向 233.5.5.5 发起了针对 <code>api.dida365.com</code> 的 DNS 请求，这验证了我们前文说的内容。</p></li></ol><p><img src=/p/dive-into-clash-dns/image-20230715193528765.png width=1460 height=169 srcset="/p/dive-into-clash-dns/image-20230715193528765_hudfd0dc39c88ff2f81e7f1d77ea97ec90_216141_480x0_resize_box_3.png 480w, /p/dive-into-clash-dns/image-20230715193528765_hudfd0dc39c88ff2f81e7f1d77ea97ec90_216141_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=863 data-flex-basis=2073px></p><h4 id=规则模式---ip-规则的解析---原理剖析>规则模式 - IP 规则的解析 - 原理剖析🏴‍☠️</h4><p>先阅读上一节，否则你可能看不懂这里写的东西。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>dns</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enable</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nameserver</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=m>119.29.29.29</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nameserver-policy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s2>&#34;api.dida365.com&#34;</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>223.5.5.5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s2>&#34;api.dida36768990.com&#34;</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>180.76.76.76</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>GEOIP,CN,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>DOMAIN,api.dida36768990.com,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>DOMAIN,api.dida365.com,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>MATCH,PROXY</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ol><li><p>浏览器访问 <code>api.dida36768990.com</code>，请求通过系统代理进入 clash</p></li><li><p><strong>遇到</strong> <strong>GEOIP 代理规则，发起本地 DNS 查询</strong></p></li><li><p>命中规则，使用 <em>namesever-policy</em> 解析域名 <code>api.dida36768990.com</code></p><p>组内没有域名形式的 DOH，<em>default-nameserver</em> 不启动，直接使用 180.76.76.76 进行域名解析。显然，我们要访问的是一个不存在的域名，自然无法得到对应的 IP（如下图绿标的 no such name信息），也即，这条通路报错了。</p></li></ol><p><img src=/p/dive-into-clash-dns/image-20230715193548913.png width=1460 height=417 srcset="/p/dive-into-clash-dns/image-20230715193548913_hudb0998eb8594acbbb17fa82290a0d41f_620412_480x0_resize_box_3.png 480w, /p/dive-into-clash-dns/image-20230715193548913_hudb0998eb8594acbbb17fa82290a0d41f_620412_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=350 data-flex-basis=840px></p><p>那么 clash 会如何处理这个请求呢？</p><p>clash ParseRule 的行进策略是 <code>for-loop with switch-case</code>，节取代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 节取
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>for</span> <span class=nx>idx</span><span class=p>,</span> <span class=nx>line</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>rulesConfig</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>parsed</span><span class=p>,</span> <span class=nx>parseErr</span> <span class=o>:=</span> <span class=nf>ParseRule</span><span class=p>(</span><span class=nx>ruleName</span><span class=p>,</span> <span class=nx>payload</span><span class=p>,</span> <span class=nx>target</span><span class=p>,</span> <span class=nx>params</span><span class=p>,</span> <span class=nx>subRules</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>parseErr</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;%s[%d] [%s] error: %s&#34;</span><span class=p>,</span> <span class=nx>format</span><span class=p>,</span> <span class=nx>idx</span><span class=p>,</span> <span class=nx>line</span><span class=p>,</span> <span class=nx>parseErr</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 节取
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>ParseRule</span><span class=p>(</span><span class=nx>ruleName</span><span class=p>,</span> <span class=nx>payload</span><span class=p>,</span> <span class=nx>target</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>params</span> <span class=p>[]</span><span class=kt>string</span><span class=p>,</span> <span class=nx>subRules</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>][]</span><span class=nx>C</span><span class=p>.</span><span class=nx>Rule</span><span class=p>)</span> <span class=p>(</span><span class=nx>parsed</span> <span class=nx>C</span><span class=p>.</span><span class=nx>Rule</span><span class=p>,</span> <span class=nx>parseErr</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>switch</span> <span class=nx>ruleName</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=s>&#34;DOMAIN&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nx>parsed</span> <span class=p>=</span> <span class=nx>RC</span><span class=p>.</span><span class=nf>NewDomain</span><span class=p>(</span><span class=nx>payload</span><span class=p>,</span> <span class=nx>target</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=s>&#34;GEOSITE&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nx>parsed</span><span class=p>,</span> <span class=nx>parseErr</span> <span class=p>=</span> <span class=nx>RC</span><span class=p>.</span><span class=nf>NewGEOSITE</span><span class=p>(</span><span class=nx>payload</span><span class=p>,</span> <span class=nx>target</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=s>&#34;GEOIP&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nx>noResolve</span> <span class=o>:=</span> <span class=nx>RC</span><span class=p>.</span><span class=nf>HasNoResolve</span><span class=p>(</span><span class=nx>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>parsed</span><span class=p>,</span> <span class=nx>parseErr</span> <span class=p>=</span> <span class=nx>RC</span><span class=p>.</span><span class=nf>NewGEOIP</span><span class=p>(</span><span class=nx>payload</span><span class=p>,</span> <span class=nx>target</span><span class=p>,</span> <span class=nx>noResolve</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=s>&#34;MATCH&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nx>parsed</span> <span class=p>=</span> <span class=nx>RC</span><span class=p>.</span><span class=nf>NewMatch</span><span class=p>(</span><span class=nx>target</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>parseErr</span> <span class=p>=</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nx>parseErr</span> <span class=p>=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;unsupported rule type %s&#34;</span><span class=p>,</span> <span class=nx>tp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>parseErr</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>parseErr</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>clash 从上至下逐行读取 rules，每个规则集都会进入到一个 case 子业务链路，我们这里进入的是 <strong>GEOIP</strong> 的 case，它首先会识别是否存在 <em><strong>no-resolve</strong></em> 标识，再以此决定 NewGEOIP 的具体行为。GEOIP 的规则匹配流程此处不过多赘述，感兴趣的小伙伴可以自行翻阅源码。</p><p>那么，根据我们先前的讨论，这里的 parseErr 必然是“有内容的”，也即<strong>这个错误传递到上层的 for 循环后会中断循环，使得程序不会行进到下一条 rule</strong>，也即 <code>DOMAIN,api.dida36768990.com,DIRECT</code> 。</p><p>换句话说，当我们试图将 <code>api.dida36768990.com</code>所对应的 IP 与规则集 <code>GEOIP,CN,PROXY</code> 进行配对时遇到了错误，这个错误首先中断匹配行进，打印错误日志，随后向上一直传导至 main 接口，沿途触发所有的 warning + 级别的日志警告。</p><p><img src=/p/dive-into-clash-dns/image-20230715193605977.png width=1460 height=206 srcset="/p/dive-into-clash-dns/image-20230715193605977_huf2ed1aa4b0b2d2c5b2dace11891aaf99_131361_480x0_resize_box_3.png 480w, /p/dive-into-clash-dns/image-20230715193605977_huf2ed1aa4b0b2d2c5b2dace11891aaf99_131361_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=708 data-flex-basis=1700px></p><h4 id=规则模式---ip-规则的解析---验证>规则模式 - IP 规则的解析 - 验证</h4><ul><li><p>GEOIP <em>no-resolve</em> only, REQUEST GET <code>api.dida365.com</code> + <code>api.dida36768990.com</code></p><p>跳过 GEOIP 的本地域名解析，直接进入下一个规则集的匹配</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>dns</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enable</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nameserver</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=m>119.29.29.29</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nameserver-policy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s2>&#34;api.dida365.com&#34;</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>223.5.5.5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s2>&#34;api.dida36768990.com&#34;</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>180.76.76.76</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>GEOIP,CN,DIRECT,no-resolve</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>MATCH,PROXY</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><img src=/p/dive-into-clash-dns/image-20230715193635868.png width=1460 height=108 srcset="/p/dive-into-clash-dns/image-20230715193635868_hu29dbd62f1b5cb17ba426b12dee120033_18562_480x0_resize_box_3.png 480w, /p/dive-into-clash-dns/image-20230715193635868_hu29dbd62f1b5cb17ba426b12dee120033_18562_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=1351 data-flex-basis=3244px></p></li><li><p>GEOIP <em>no-resolve && DOMAIN,</em> REQUEST GET <code>api.dida365.com</code> + <code>api.dida36768990.com</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>dns</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enable</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nameserver</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=m>119.29.29.29</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nameserver-policy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s2>&#34;api.dida365.com&#34;</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>223.5.5.5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s2>&#34;api.dida36768990.com&#34;</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>180.76.76.76</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>GEOIP,CN,DIRECT,no-resolve</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>DOMAIN,api.dida36768990.com,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>DOMAIN,api.dida365.com,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>MATCH,PROXY</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>跳过「访问域名遇到 GEOIP 规则本该进行的本地 DNS 解析」直接进入下一个规则集的匹配，接下来的两条<strong>直连域名规则</strong>的情况属于已讨论过的正常情况，也即，发起本地 DNS 请求。</p><p><img src=/p/dive-into-clash-dns/image-20230715193647978.png width=1460 height=407 srcset="/p/dive-into-clash-dns/image-20230715193647978_hu67870031026e59b44c3eba42446defdc_575102_480x0_resize_box_3.png 480w, /p/dive-into-clash-dns/image-20230715193647978_hu67870031026e59b44c3eba42446defdc_575102_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=358 data-flex-basis=860px></p></li><li><p>规则模式 - 向全局过渡</p><p>修改 rules</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>MATCH,PROXY</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><img src=/p/dive-into-clash-dns/image-20230715193704407.png width=1460 height=96 srcset="/p/dive-into-clash-dns/image-20230715193704407_hub76f8e495285eacea77f5471c597eac7_17848_480x0_resize_box_3.png 480w, /p/dive-into-clash-dns/image-20230715193704407_hub76f8e495285eacea77f5471c597eac7_17848_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=1520 data-flex-basis=3650px></p><p><img src=/p/dive-into-clash-dns/image-20230715193711612.png width=1460 height=490 srcset="/p/dive-into-clash-dns/image-20230715193711612_hu3f820a12da0ac190aa52f04559d24a69_91050_480x0_resize_box_3.png 480w, /p/dive-into-clash-dns/image-20230715193711612_hu3f820a12da0ac190aa52f04559d24a69_91050_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=297 data-flex-basis=715px></p><p>这近似于全局（代理）模式，所有经由 clash 的请求都被呈递到远程服务器，DNS解析由远程服务器完成，本地扫不到经由 clash DNS 的请求纪录。</p><h4 id=全局模式---全局代理全局直连与全局拒绝>全局模式 - 全局代理，全局直连与全局拒绝</h4><p>该模式下，我们可以指定所有请求都 代理/DIRECT/REJECT。其中，代理可以细分为某个代理组或某个代理节点。</p><p><em><strong>代理</strong></em>：所有经由 clash 的请求都被呈递到远程服务器，DNS解析由远程服务器完成，本地扫不到 DNS 请求纪录。具体由哪个服务器处理请求取决于你的配置。</p><p><em><strong>DIRECT</strong></em>：所有经由 clash 的请求都从本地发出，DNS解析行为由 dns 字段定义的策略决定，本地可以扫到未加密的纪录。</p><p><img src=/p/dive-into-clash-dns/image-20230715193735385.png width=1460 height=193 srcset="/p/dive-into-clash-dns/image-20230715193735385_hua739caf696c3c3288b1a1e9964c5668e_261736_480x0_resize_box_3.png 480w, /p/dive-into-clash-dns/image-20230715193735385_hua739caf696c3c3288b1a1e9964c5668e_261736_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=756 data-flex-basis=1815px></p><p><em><strong>REJECT</strong></em>: 所有经由 clash 的请求都被甩入黑洞，此时你访问任何网站都会显示 <em>ERR_CONNECTION_CLOSED</em> 的警告，虽然这并不意味着你没法上网，但至少你浏览器是没法用了。🥹同全局代理，此时 DNS 配置不起作用。</p><p>如果与上一节内容作比较，你可以这样理解：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span>- <span class=l>MATCH,PROXY </span><span class=w> </span><span class=c># 全局代理（使用名为 PROXY 的代理组）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span>- <span class=l>MATCH,DIRECT</span><span class=w> </span><span class=c># 全局直连</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span>- <span class=l>MATCH,REJECT</span><span class=w> </span><span class=c># 全局拒绝</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>Best Practices - DNS 分流配置</p><p>想啥呢🎃才开始进阶怎么会有最佳实践配置</p><p>想啥呢🐧我们还没开始 <strong>&lt;困难></strong> 和 <strong></strong>章节内容的介绍~</p><p>不过，我们是时候来个阶段性的最佳实践总结了，后续介绍的内容也不会和如下结论冲突。</p><ol><li><p>编排 rules 规则时，先写域名匹配再写 IP 匹配，最后 <code>MATCH</code> 兜底。</p><p>默认出站选择 PROXY 还是 DIRECT 取决于你的性癖上网习惯，进而决定选择 白名单 还是 黑名单 的编排方案。</p><ul><li><code>MATCH,PROXY</code> 兜底，建议遵从如上 rules 最佳实践的前提下，先编排 PROXY 出站规则再编排 DIRECT 出站规则</li><li><code>MATCH,DIRECT</code> 兜底，反之。</li></ul></li><li><p>优先使用 RULE-SET，只需添加未在上游规则集中出现的规则。</p><p>尽管目前这些规则集至少有几十万条数据，但在精心设计的 Mapping 策略下，规则匹配的耗时是忽略不计的。</p><p>此外，你可能需要将这条规则 <code>RULE-SET,applications,DIRECT</code> 添加到你的 rules 首行。</p></li><li><p>当访问域名遇到 <strong>IP 规则</strong> 或 <strong>域名直连规则</strong>时，本地发起 DNS 请求。</p><p>需要注意的是，你添加的 classical RULE-SET 可能也包含域名直连规则以及 IP 规则</p></li><li><p>clash DNS Mapping</p><ul><li>使用 <em>nameserver-policy</em> 和 <em>nameserver</em> 解析我们即将访问的域名，前者优先启动。</li><li>需要使用 <em>default-nameserver</em> 解析上述两个策略组中的域名，也即，<em>default-nameserver</em> 需要使用 IP 写法（可以是 IP 形式的 DOH），避免出现鸡蛋问题。</li><li>这三个策略组的网络请求是并发行进的。如果存在多个并发查询，clash 优先采用最速响应的 IP 作为域名的查询结果。</li><li>不必修改（覆盖）默认的 <em>default-nameserver</em>，而 <em>nameserver-policy</em> 和 <em>nameserver</em> 尽可能使用 IP 形式的 DOH，省去这个间接的解析步骤。</li><li>在设置 <em>nameserver-policy</em> 和 <em>nameserver</em> 时使用 DOH，而非 DOT/DOQ。</li></ul></li></ol><p>我们可以凭借上述特性组合出「国外DNS」和「直连DNS」的概念，你可以说这是一个精妙的巧合，但也可以说这是社区智慧的结晶。</p><h4 id=public-dns---已知的-dns-提供商>Public DNS - 已知的 DNS 提供商</h4><ul><li><p><a class=link href=https://github.com/QIN2DIM/tuic-installer/wiki/%e5%85%ac%e6%9c%89-DNS-%e6%b1%87%e6%80%bb-DOT-DOH-DOQ target=_blank rel=noopener>公有 DNS 汇总 DOT DOH DOQ · QIN2DIM/tuic-installer</a></p></li><li><p><a class=link href=https://adguard-dns.io/kb/zh-CN/general/dns-providers/#default target=_blank rel=noopener>已知的 DNS 提供商 | AdGuard DNS Knowledge Base</a></p></li></ul></li></ul><h2 id=原理篇>原理篇</h2><blockquote><p>💡Let&rsquo;s analyze this systematically.</p></blockquote><h3 id=clash-flow---dns>Clash flow - DNS</h3><p>流程图</p><h3 id=clash-flow---proxy>Clash flow - Proxy</h3><p>流程图</p><h2 id=泄漏篇>泄漏篇</h2><h3 id=dns-泄漏---概念界定>DNS 泄漏 - 概念界定</h3><ol><li>用户开启 VPN 后，正常网上冲浪产生的 DNS 请求被 <strong>本地</strong> 上游 ISP 捕获。</li><li>因此，本地上游 ISP 知道 <strong>&lt;某人></strong> 要解析的 <strong>&lt;某域名></strong> 。</li></ol><h3 id=dns-泄漏---争议点>DNS 泄漏 - 争议点</h3><h4 id=vpn-的-dns-泄漏>VPN 的 DNS 泄漏</h4><p>在正常情况下，开启 VPN 后，VPN 软件将用户的「访问请求」呈送至远程服务器，访问网站的工作由远程服务器完成，也即，DNS 请求由远程服务器发出。</p><p>此时出现了一些不可抗力因素，用户向目标网站发起了直连请求，或者说，本地发起了向「系统网关 → 上游 ISP」的 DNS 查询。有可能是 VPN 软件没有劫持到这个请求，也有可能是用户配置出了问题，总之就是 DNS 请求不仅发往了 VPN 提供的 DNS ，也发往了本地 ISP。</p><p>In the case，尽管你配置了 DOH，但作为解析 DNS 请求的上游 ISP 它必然是能看到你要访问的 网址（域名），不然它没法给你查询域名对应的 IP（DNS基本原理不过多赘述）。</p><h4 id=proxy-的-dns-泄漏>Proxy 的 DNS 泄漏</h4><p>clash 等代理核心出现了规则模式的设定，在合理的配置下：</p><ol><li>访问国内站点（如 <code>geosite:cn</code>），直接从本机发起请求。</li><li>访问我们标记的站点（如 youtube），则将请求呈送至远程服务器，代理访问。</li></ol><p>绝大多数玩家使用的都是规则模式下的系统代理，例如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>DOMAIN-SUFFIX,youtube.com,PROXY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>GEOSITE,CN,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>dns</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enable</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nameserver-policy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s2>&#34;geosite:cn&#34;</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;https://223.5.5.5/dns-query&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>在这种常见配置下，我们直连访问国内站点（如 bilibili）所产生的 DNS 请求，必然被<strong>国内DNS</strong> 提供商捕获。这种算 <strong>DNS 泄漏</strong> 吗？我觉得不算。</p><p>根据我们上文提到的定义，<strong>DNS泄漏指的是我们使用代理访问 <code>www.youtube.com</code> ，却从本地发送 DNS 请求到国内 ISP 查询 <code>www.youtube.com</code> 对应的 IP ，因此上游知道了你曾访问油管。</strong></p><p>显然，在配置正确的情况下不可能出现这种事故 根据我们上文的实验结论，域名请求遇到域名规则，命中规则后，如果是代理出站，我们会将访问请求呈送至远程服务器，DNS 查询由远程服务器完成。</p><p>也即，当你配置了 <code>DOMAIN-SUFFIX,youtube.com,PROXY</code> 这条规则时，本地不会发起对 <code>+.youtube.com</code> 的域名解析。（假设已禁用DNS策略组）</p><p>这与我们先前提到的 VPN 行为模式不同。我们的意图在于：</p><ol><li>我们启用了规则模式，旨在避免远程服务器处理我们对国内网站的访问请求。我们希望访问国内网站而从本地发起的 「DNS 请求」经过本地运营商，以此获得更低的网络延迟。</li><li>不希望本地运营商捕获到我们对标记网点（如 <code>www.youtube.com</code>）的访问请求。</li></ol><p>换句话说，一个 DNS 请求过来，运营商必然知道有人正在访问 <code>www.youtube.com</code>，而代理访问的本质在于不让运营商知道访客的真实身份。</p><h3 id=dns-泄漏---检测工具>DNS 泄漏 - 检测工具</h3><ul><li><p><a class=link href=https://browserleaks.com/ip target=_blank rel=noopener>My IP Address - BrowserLeaks</a></p></li><li><p><a class=link href=https://ipleak.net/ target=_blank rel=noopener>IP/DNS Detect - What is your IP, what is your DNS, what informations you send to websites. (ipleak.net)</a></p></li></ul><h3 id=dns-泄漏---检测原理>DNS 泄漏 - 检测原理</h3><p>如果你还不知道什么是 DNS 泄漏可以从前文看起，泄漏的定义大致如下图所示：</p><ol><li>✅直连访问 <a class=link href=http://bilibili.com target=_blank rel=noopener>bilibili.com</a> ，由本地 PC 向上游 DNS 发送查询</li><li>✅代理访问 <a class=link href=http://google.com target=_blank rel=noopener>google.com</a>，由远程服务器向国外 DNS 发送查询</li><li>❌代理访问 <a class=link href=http://google.com target=_blank rel=noopener>google.com</a>，由本地 PC 向上游 DNS 发送查询</li></ol><p><img src=/p/dive-into-clash-dns/image-20230715195243552.png width=1460 height=772 srcset="/p/dive-into-clash-dns/image-20230715195243552_hu966c9fbc6ce7f3424ae165e5d9422d58_436671_480x0_resize_box_3.png 480w, /p/dive-into-clash-dns/image-20230715195243552_hu966c9fbc6ce7f3424ae165e5d9422d58_436671_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=189 data-flex-basis=453px></p><p>实验开始前，编排如下规则：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>dns</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enable</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nameserver</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=m>223.5.5.5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nameserver-policy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s2>&#34;ipleak.net&#34;</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>1.0.0.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>GEOSITE,CN,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>GEOIP,CN,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>MATCH,PROXY</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>以 <a class=link href=https://ipleak.net target=_blank rel=noopener>ipleak.net</a> 爲例说明 DNS 泄漏检测的工作原理。</p><p>当你访问 DNS 泄漏检测的站点后，发生了如下事件：</p><ol><li><p><code>ipleak.net</code> 后端服务器向前端页面不断推送新的数据包，这些数据包的 Request URL 都是 <code>+.ipleak.net</code> 形式，例如：</p><p><img src=/p/dive-into-clash-dns/image-20230715195310133.png width=1460 height=346 srcset="/p/dive-into-clash-dns/image-20230715195310133_hu289f06ccb641c26a062a4aa1c2061a82_159612_480x0_resize_box_3.png 480w, /p/dive-into-clash-dns/image-20230715195310133_hu289f06ccb641c26a062a4aa1c2061a82_159612_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=421 data-flex-basis=1012px></p></li><li><p>浏览器发起 Request并构造 DNS 请求查询这些域名对应的 IP</p><p>虽然这些域名是随机生成的，但它们都被正确解析到有效的后端端点，我们可以通过 DNS 查询到 Request Domain 对应的（CDN）IP。</p><p><img src=/p/dive-into-clash-dns/image-20230715195319858.png width=1460 height=417 srcset="/p/dive-into-clash-dns/image-20230715195319858_hu12ef14c98df114824b87e431a300c211_616831_480x0_resize_box_3.png 480w, /p/dive-into-clash-dns/image-20230715195319858_hu12ef14c98df114824b87e431a300c211_616831_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=350 data-flex-basis=840px></p><p>显然，这些随机生成的域名不可能存在于任何 GEOSITE，RULE-SET 数据库中（项目维护者也不会添加这些特殊的域名）也就是说，这些访问请求进入 clash 后，走的一定是兜底的 <code>MATCH,PROXY</code> 规则（除非你把 <code>ipleak.net</code> 这个域名配置到规则里了🥹）。</p><p>我们通常会把兜底规则写在最后一行，意味着每个访问请求都会把你的 <em>rules</em> 扫一遍。在这个过程中，沿途遇到的首条 IP 规则（例如我们配置的 <code>GEOIP</code>）会触发本地 DNS 解析，「你配置的 DNS 的上游DNS」以及最终流向的「权威域名服务器」的 Server IP 会被域名检测网站记录下来，最终打印到前端页面上。</p><p>访问请求最后命中 <code>MATCH,PROXY</code> 代理出站规则，所以远程服务器必然发起 DNS 查询请求，也即，在开启代理的情况下，前端页面会打印出落地机所在区域的国旗以及落地机上游 ISP DNS 信息 。</p></li><li><p>直连访问 - 正常情况</p><p>如果你没理解我刚说的东西，你可以尝试不使用代理直接访问 <code>ipleak.net</code>，你可以看到页面被国旗刷屏了。这些 IP 来自你选用的 DNS 以及你上游的 ISP DNS。</p></li><li><p>代理访问 - 正常情况</p><p>DNS 请求由远程服务器发起，远程服务器也会有自己的系统 DNS 和上游 ISP，在没有特殊设计网关的情况下，你能看到 <code>ipleak.net</code> 页面上不断刷出远程服务器所在地区的国旗以及由远程服务器发起的 DNS 请求经过的 server IP。</p><p>如果你的远程服务器网络环境比较特殊，你会看到来自多个国家和地区的 server IP。</p></li><li><p>代理访问 - 异常情况</p><p>如果检测站点能够通过记录 DNS server IP 的方式返回发送端 PC 的真实所在地，说明发生了 DNS 泄漏。</p><p><strong>这里加了超长的定语：</strong></p><ul><li>✅本地没有发起 DNS 查询，不可能存在泄漏</li><li>🚫本地发起 DNS 查询，使用系统 DNS 或国内 DNS，能够通过三要素定位还原出 zero 发送端的大致位置。例如 <code>ipleak.net</code> 等公有服务提供的粗糙定位能够显示国旗，但显然有更精密的技术能够做到经纬度级别的定位。</li><li>👁️‍🗨️本地发起 DNS 查询，但使用的是经过特殊设计的 DNS 或其他地区的 DNS，不能或几乎不可能通过三要素定位还原出 zero 发送端的大致位置。</li></ul><p>🌀<strong>迷思与争议：</strong></p><ol><li><p><strong><code>ipleak.net</code>出现了国旗，我的配置出现致命错误了吗？</strong></p><p><code>ipleak.net</code> 出现了你所在地的国旗，并不代表你访问 youtube google 的请求会被本地运营商截获。我们上文提到过（如果你使用的是本文提到的配置或是 <a class=link href=https://wiki.metacubex.one/example/#_2 target=_blank rel=noopener>meta 懒人配置</a>），类似访问 youtube 的请求在 IP 规则之前必然命中 <em>PROXY</em> 出站规则， 本地不会产生对 <code>youtube.com</code> 的 DNS 解析请求，也就不会有被本地运营商截获这一说。</p><p>如果你只关注访问 youtube google 等网站的意图数据漏没漏，那你被 <code>ipleak.net</code> 等一众检测站点爆菊了也无伤大雅。</p><p>但必须说明的是，出现了国旗，说明你向上游 ISP 发起了针对「意外站点」的 DNS 请求，ipleak 能够还原你的所在地，这属于 DNS 泄漏的范畴。 如果有某个网站借助 ipleak 等检测服务追溯发送端的大致服务区，你大概率会被精确到市区级运营商。</p></li><li><p><strong><code>ipleak.net</code>没有出现国旗，我的配置正常吗？</strong></p><p>如果你用的是 VPN，你的配置正常。但你用的是 clash，这个问题存在争议。</p><p>例如，访问 <code>youtube.com</code> 但 <em>rules</em> 里出现了 <code>DOMAIN-SUFFIX,youtube.com,DIRECT</code> 这种奇怪的东西，或者提前遇到了 IP 规则，那么，本地会发起 DNS 请求。但是，如果你在 <em>nameserver</em> 中配置了 <code>https://security.cloudflare-dns.com/dns-query</code> 这样的国外（或其他地区）的 DOH，泄漏检测站点是无法记录到你的真实所在地的。</p><p>显然，这种情况与我们界定的 DNS 泄漏有所冲突。</p><p>广义上讲，访问应该被代理的网站的 DNS 请求必须由落地代理产生，而真正的发送端被隐藏起来。如果你认为只要访问被代理的网站时，本地发起了 DNS 请求就算泄漏的话，这种情况属于 DNS 泄漏，你的配置不正常。</p><p>狭义上讲，如果你觉得尽管本地发起了 DNS 请求，但只要不被正确溯源就可以接受。那么在兼顾延迟和安全的前提下，选择经过特殊设计的境外 DOH / DOQ 是个不错的选择<a class=link href="https://www.notion.so/Dive-into-Clash-DNS-a025c9bb5f724972a2ffb7984ae4a6ca?pvs=21" target=_blank rel=noopener>查看已知的免审查公有 DNS</a>。</p></li></ol></li></ol><h3 id=如何避免-dns-泄漏>如何避免 DNS 泄漏</h3><h2 id=触类旁通>触类旁通</h2><h3 id=tunnel-mode>TUNNEL Mode</h3><h3 id=enhanced-mode>Enhanced Mode</h3><h4 id=dnsmaping>DNSMaping</h4><h4 id=fakeip-clash--meta>FakeIP: Clash & Meta</h4><h4 id=fakedns-v2ray--sing-box>FakeDNS: v2ray & sing-box</h4><h4 id=l3-loss-but-deepin-magic>L3: Loss but deepin magic</h4><h3 id=软路由---物理超度>软路由 - 物理超度</h3><h2 id=一叶知秋>一叶知秋</h2><h3 id=处理-squad-eac-反外挂验证>处理 Squad EAC 反外挂验证</h3><h3 id=解锁流媒体>解锁流媒体</h3><h3 id=绕过-chatgpt-网络审查>绕过 ChatGPT 网络审查</h3><h2 id=天外飞仙>天外飞仙</h2><h3 id=基于-rust-实现-pbq-quic-based-拥塞控制算法>基于 Rust 实现 PBQ QUIC-based 拥塞控制算法</h3><ul><li><p>Paper: <a class=link href=https://www.mdpi.com/1099-4300/25/2/294 target=_blank rel=noopener>《PBQ-Enhanced QUIC: QUIC with Deep Reinforcement Learning Congestion Control Mechanism》</a></p></li><li><p>PDF: <a class=link href=entropy-25-00294-v2.pdf>entropy-25-00294-v2.pdf</a></p></li></ul><h2 id=clashmeta-参考配置>Clash.Meta 参考配置</h2><ol><li><a class=link href=https://wiki.metacubex.one/example/#_2 target=_blank rel=noopener>Meta 官方提供的懒人配置</a></li><li><a class=link href=https://github.com/QIN2DIM/tuic-installer/wiki/Clash.Meta-configuration target=_blank rel=noopener>本篇博客的附件</a></li></ol><h2 id=whats-more>What&rsquo;s more</h2><h3 id=术语表>术语表</h3><ol><li><p>clash rules 直连，代理，拒绝</p></li><li><p>v2fly / sing-box rules 直连（绕过），代理，阻止</p></li><li><p>DNS</p></li><li><p>Clash DNS</p><ol><li>nameserver-policy</li><li>default-nameserver</li><li>nameserver</li><li>proxy-server-nameserver</li><li>fake-ip enhancer<ul><li><a class=link href=https://www.hostinger.com/tutorials/fqdn#What_is_FQDN target=_blank rel=noopener>FQDN</a></li><li>FakeIP Pool</li></ul></li></ol></li><li><p>DNS leak</p><p>概念界定：广义、狭义</p><ul><li><a class=link href=http://ipleak.net/ target=_blank rel=noopener>http://ipleak.net/</a></li><li><a class=link href=https://browserleaks.com/ip target=_blank rel=noopener>https://browserleaks.com/ip</a></li></ul></li><li><p>DOH / DOT / DOQ / ODOH</p><ul><li><a class=link href=https://adguard-dns.io/en/blog/dns-over-quic.html target=_blank rel=noopener>https://adguard-dns.io/en/blog/dns-over-quic.html</a></li></ul></li></ol><h3 id=源码阅读>源码阅读</h3><h4 id=初始化配置>初始化配置</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>UnmarshalRawConfig</span><span class=p>(</span><span class=nx>buf</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>RawConfig</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// config with default value
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>rawCfg</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>RawConfig</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>AllowLan</span><span class=p>:</span>        <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>BindAddress</span><span class=p>:</span>     <span class=s>&#34;*&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>IPv6</span><span class=p>:</span>            <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Mode</span><span class=p>:</span>            <span class=nx>T</span><span class=p>.</span><span class=nx>Rule</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>GeodataMode</span><span class=p>:</span>     <span class=nx>C</span><span class=p>.</span><span class=nx>GeodataMode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>GeodataLoader</span><span class=p>:</span>   <span class=s>&#34;memconservative&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>UnifiedDelay</span><span class=p>:</span>    <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Authentication</span><span class=p>:</span>  <span class=p>[]</span><span class=kt>string</span><span class=p>{},</span>
</span></span><span class=line><span class=cl>		<span class=nx>LogLevel</span><span class=p>:</span>        <span class=nx>log</span><span class=p>.</span><span class=nx>INFO</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Hosts</span><span class=p>:</span>           <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>any</span><span class=p>{},</span>
</span></span><span class=line><span class=cl>		<span class=nx>Rule</span><span class=p>:</span>            <span class=p>[]</span><span class=kt>string</span><span class=p>{},</span>
</span></span><span class=line><span class=cl>		<span class=nx>Proxy</span><span class=p>:</span>           <span class=p>[]</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>any</span><span class=p>{},</span>
</span></span><span class=line><span class=cl>		<span class=nx>ProxyGroup</span><span class=p>:</span>      <span class=p>[]</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>any</span><span class=p>{},</span>
</span></span><span class=line><span class=cl>		<span class=nx>TCPConcurrent</span><span class=p>:</span>   <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>FindProcessMode</span><span class=p>:</span> <span class=nx>P</span><span class=p>.</span><span class=nx>FindProcessStrict</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Tun</span><span class=p>:</span> <span class=nx>RawTun</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>Enable</span><span class=p>:</span>              <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Device</span><span class=p>:</span>              <span class=s>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Stack</span><span class=p>:</span>               <span class=nx>C</span><span class=p>.</span><span class=nx>TunGvisor</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>DNSHijack</span><span class=p>:</span>           <span class=p>[]</span><span class=kt>string</span><span class=p>{</span><span class=s>&#34;0.0.0.0:53&#34;</span><span class=p>},</span> <span class=c1>// default hijack all dns query
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>AutoRoute</span><span class=p>:</span>           <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>AutoDetectInterface</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Inet6Address</span><span class=p>:</span>        <span class=p>[]</span><span class=nx>LC</span><span class=p>.</span><span class=nx>ListenPrefix</span><span class=p>{</span><span class=nx>LC</span><span class=p>.</span><span class=nf>ListenPrefix</span><span class=p>(</span><span class=nx>netip</span><span class=p>.</span><span class=nf>MustParsePrefix</span><span class=p>(</span><span class=s>&#34;fdfe:dcba:9876::1/126&#34;</span><span class=p>))},</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=nx>TuicServer</span><span class=p>:</span> <span class=nx>RawTuicServer</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>Enable</span><span class=p>:</span>                <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Token</span><span class=p>:</span>                 <span class=kc>nil</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Users</span><span class=p>:</span>                 <span class=kc>nil</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Certificate</span><span class=p>:</span>           <span class=s>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>PrivateKey</span><span class=p>:</span>            <span class=s>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Listen</span><span class=p>:</span>                <span class=s>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>CongestionController</span><span class=p>:</span>  <span class=s>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>MaxIdleTime</span><span class=p>:</span>           <span class=mi>15000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>AuthenticationTimeout</span><span class=p>:</span> <span class=mi>1000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>ALPN</span><span class=p>:</span>                  <span class=p>[]</span><span class=kt>string</span><span class=p>{</span><span class=s>&#34;h3&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>			<span class=nx>MaxUdpRelayPacketSize</span><span class=p>:</span> <span class=mi>1500</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=nx>EBpf</span><span class=p>:</span> <span class=nx>EBpf</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>RedirectToTun</span><span class=p>:</span> <span class=p>[]</span><span class=kt>string</span><span class=p>{},</span>
</span></span><span class=line><span class=cl>			<span class=nx>AutoRedir</span><span class=p>:</span>     <span class=p>[]</span><span class=kt>string</span><span class=p>{},</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=nx>IPTables</span><span class=p>:</span> <span class=nx>IPTables</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>Enable</span><span class=p>:</span>           <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>InboundInterface</span><span class=p>:</span> <span class=s>&#34;lo&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Bypass</span><span class=p>:</span>           <span class=p>[]</span><span class=kt>string</span><span class=p>{},</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=nx>DNS</span><span class=p>:</span> <span class=nx>RawDNS</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>Enable</span><span class=p>:</span>       <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>IPv6</span><span class=p>:</span>         <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>UseHosts</span><span class=p>:</span>     <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>IPv6Timeout</span><span class=p>:</span>  <span class=mi>100</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>EnhancedMode</span><span class=p>:</span> <span class=nx>C</span><span class=p>.</span><span class=nx>DNSMapping</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>FakeIPRange</span><span class=p>:</span>  <span class=s>&#34;198.18.0.1/16&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>FallbackFilter</span><span class=p>:</span> <span class=nx>RawFallbackFilter</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>GeoIP</span><span class=p>:</span>     <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>GeoIPCode</span><span class=p>:</span> <span class=s>&#34;CN&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>IPCIDR</span><span class=p>:</span>    <span class=p>[]</span><span class=kt>string</span><span class=p>{},</span>
</span></span><span class=line><span class=cl>				<span class=nx>GeoSite</span><span class=p>:</span>   <span class=p>[]</span><span class=kt>string</span><span class=p>{},</span>
</span></span><span class=line><span class=cl>			<span class=p>},</span>
</span></span><span class=line><span class=cl>			<span class=nx>DefaultNameserver</span><span class=p>:</span> <span class=p>[]</span><span class=kt>string</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;114.114.114.114&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;223.5.5.5&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;8.8.8.8&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;1.0.0.1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>},</span>
</span></span><span class=line><span class=cl>			<span class=nx>NameServer</span><span class=p>:</span> <span class=p>[]</span><span class=kt>string</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;&lt;https://doh.pub/dns-query&gt;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;tls://223.5.5.5:853&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>},</span>
</span></span><span class=line><span class=cl>			<span class=nx>FakeIPFilter</span><span class=p>:</span> <span class=p>[]</span><span class=kt>string</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;dns.msftnsci.com&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;www.msftnsci.com&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;www.msftconnecttest.com&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=nx>Sniffer</span><span class=p>:</span> <span class=nx>RawSniffer</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>Enable</span><span class=p>:</span>          <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Sniffing</span><span class=p>:</span>        <span class=p>[]</span><span class=kt>string</span><span class=p>{},</span>
</span></span><span class=line><span class=cl>			<span class=nx>ForceDomain</span><span class=p>:</span>     <span class=p>[]</span><span class=kt>string</span><span class=p>{},</span>
</span></span><span class=line><span class=cl>			<span class=nx>SkipDomain</span><span class=p>:</span>      <span class=p>[]</span><span class=kt>string</span><span class=p>{},</span>
</span></span><span class=line><span class=cl>			<span class=nx>Ports</span><span class=p>:</span>           <span class=p>[]</span><span class=kt>string</span><span class=p>{},</span>
</span></span><span class=line><span class=cl>			<span class=nx>ForceDnsMapping</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>ParsePureIp</span><span class=p>:</span>     <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>OverrideDest</span><span class=p>:</span>    <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=nx>Profile</span><span class=p>:</span> <span class=nx>Profile</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>StoreSelected</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=nx>GeoXUrl</span><span class=p>:</span> <span class=nx>RawGeoXUrl</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>Mmdb</span><span class=p>:</span>    <span class=s>&#34;&lt;https://testingcf.jsdelivr.net/gh/MetaCubeX/meta-rules-dat@release/country.mmdb&gt;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>GeoIp</span><span class=p>:</span>   <span class=s>&#34;&lt;https://testingcf.jsdelivr.net/gh/MetaCubeX/meta-rules-dat@release/geoip.dat&gt;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>GeoSite</span><span class=p>:</span> <span class=s>&#34;&lt;https://testingcf.jsdelivr.net/gh/MetaCubeX/meta-rules-dat@release/geosite.dat&gt;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>yaml</span><span class=p>.</span><span class=nf>Unmarshal</span><span class=p>(</span><span class=nx>buf</span><span class=p>,</span> <span class=nx>rawCfg</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>rawCfg</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=dnsmode-alias>DNSMode Alias</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>e</span> <span class=nx>DNSMode</span><span class=p>)</span> <span class=nf>String</span><span class=p>()</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>switch</span> <span class=nx>e</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=nx>DNSNormal</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=s>&#34;normal&#34;</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=nx>DNSFakeIP</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=s>&#34;fake-ip&#34;</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=nx>DNSMapping</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=s>&#34;redir-host&#34;</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=nx>DNSHosts</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=s>&#34;hosts&#34;</span>
</span></span><span class=line><span class=cl>	<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=s>&#34;unknown&#34;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=type-rawdns-struct>type RawDNS struct</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>RawDNS</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Enable</span>                <span class=kt>bool</span>              <span class=s>`yaml:&#34;enable&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>PreferH3</span>              <span class=kt>bool</span>              <span class=s>`yaml:&#34;prefer-h3&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>IPv6</span>                  <span class=kt>bool</span>              <span class=s>`yaml:&#34;ipv6&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>IPv6Timeout</span>           <span class=kt>uint</span>              <span class=s>`yaml:&#34;ipv6-timeout&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>UseHosts</span>              <span class=kt>bool</span>              <span class=s>`yaml:&#34;use-hosts&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>NameServer</span>            <span class=p>[]</span><span class=kt>string</span>          <span class=s>`yaml:&#34;nameserver&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>Fallback</span>              <span class=p>[]</span><span class=kt>string</span>          <span class=s>`yaml:&#34;fallback&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>FallbackFilter</span>        <span class=nx>RawFallbackFilter</span> <span class=s>`yaml:&#34;fallback-filter&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>Listen</span>                <span class=kt>string</span>            <span class=s>`yaml:&#34;listen&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>EnhancedMode</span>          <span class=nx>C</span><span class=p>.</span><span class=nx>DNSMode</span>         <span class=s>`yaml:&#34;enhanced-mode&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>FakeIPRange</span>           <span class=kt>string</span>            <span class=s>`yaml:&#34;fake-ip-range&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>FakeIPFilter</span>          <span class=p>[]</span><span class=kt>string</span>          <span class=s>`yaml:&#34;fake-ip-filter&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>DefaultNameserver</span>     <span class=p>[]</span><span class=kt>string</span>          <span class=s>`yaml:&#34;default-nameserver&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>NameServerPolicy</span>      <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>any</span>    <span class=s>`yaml:&#34;nameserver-policy&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>ProxyServerNameserver</span> <span class=p>[]</span><span class=kt>string</span>          <span class=s>`yaml:&#34;proxy-server-nameserver&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=dns-默认配置>DNS 默认配置</h4><p><a class=link href=https://github.com/MetaCubeX/Clash.Meta/blob/8d1251f1287846daf42db4151b707d9f677be5a1/config/config.go#L377 target=_blank rel=noopener>Clash.Meta/config/config.go MetaCubeX/Clash.Meta</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>DNS</span><span class=p>:</span> <span class=nx>RawDNS</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>Enable</span><span class=p>:</span>       <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>IPv6</span><span class=p>:</span>         <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>UseHosts</span><span class=p>:</span>     <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>IPv6Timeout</span><span class=p>:</span>  <span class=mi>100</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>EnhancedMode</span><span class=p>:</span> <span class=nx>C</span><span class=p>.</span><span class=nx>DNSMapping</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>FakeIPRange</span><span class=p>:</span>  <span class=s>&#34;198.18.0.1/16&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>FallbackFilter</span><span class=p>:</span> <span class=nx>RawFallbackFilter</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>GeoIP</span><span class=p>:</span>     <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>GeoIPCode</span><span class=p>:</span> <span class=s>&#34;CN&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>IPCIDR</span><span class=p>:</span>    <span class=p>[]</span><span class=kt>string</span><span class=p>{},</span>
</span></span><span class=line><span class=cl>				<span class=nx>GeoSite</span><span class=p>:</span>   <span class=p>[]</span><span class=kt>string</span><span class=p>{},</span>
</span></span><span class=line><span class=cl>			<span class=p>},</span>
</span></span><span class=line><span class=cl>			<span class=nx>DefaultNameserver</span><span class=p>:</span> <span class=p>[]</span><span class=kt>string</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;114.114.114.114&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;223.5.5.5&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;8.8.8.8&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;1.0.0.1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>},</span>
</span></span><span class=line><span class=cl>			<span class=nx>NameServer</span><span class=p>:</span> <span class=p>[]</span><span class=kt>string</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;&lt;https://doh.pub/dns-query&gt;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;tls://223.5.5.5:853&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>},</span>
</span></span><span class=line><span class=cl>			<span class=nx>FakeIPFilter</span><span class=p>:</span> <span class=p>[]</span><span class=kt>string</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;dns.msftnsci.com&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;www.msftnsci.com&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=s>&#34;www.msftconnecttest.com&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=type-pool-struct>type Pool struct</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Pool is an implementation about fake ip generator without storage
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>Pool</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>gateway</span> <span class=nx>netip</span><span class=p>.</span><span class=nx>Addr</span>
</span></span><span class=line><span class=cl>	<span class=nx>first</span>   <span class=nx>netip</span><span class=p>.</span><span class=nx>Addr</span>
</span></span><span class=line><span class=cl>	<span class=nx>last</span>    <span class=nx>netip</span><span class=p>.</span><span class=nx>Addr</span>
</span></span><span class=line><span class=cl>	<span class=nx>offset</span>  <span class=nx>netip</span><span class=p>.</span><span class=nx>Addr</span>
</span></span><span class=line><span class=cl>	<span class=nx>cycle</span>   <span class=kt>bool</span>
</span></span><span class=line><span class=cl>	<span class=nx>mux</span>     <span class=nx>sync</span><span class=p>.</span><span class=nx>Mutex</span>
</span></span><span class=line><span class=cl>	<span class=nx>host</span>    <span class=o>*</span><span class=nx>trie</span><span class=p>.</span><span class=nx>DomainTrie</span><span class=p>[</span><span class=kd>struct</span><span class=p>{}]</span>
</span></span><span class=line><span class=cl>	<span class=nx>ipnet</span>   <span class=o>*</span><span class=nx>netip</span><span class=p>.</span><span class=nx>Prefix</span>
</span></span><span class=line><span class=cl>	<span class=nx>store</span>   <span class=nx>store</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=geositegeoip-大小写不敏感>GEOSITE，GEOIP 大小写不敏感</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 将国家代码转成小写后再匹配
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>LoadGeoSiteMatcher</span><span class=p>(</span><span class=nx>countryCode</span> <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=o>--</span> <span class=nx>skip</span> <span class=o>--</span>
</span></span><span class=line><span class=cl>	<span class=nx>countryCode</span> <span class=p>=</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>ToLower</span><span class=p>(</span><span class=nx>countryCode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=o>--</span> <span class=nx>skip</span> <span class=o>--</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// LAN 特例，必须大写才能匹配规则
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>LoadGeoIPMatcher</span><span class=p>(</span><span class=nx>country</span> <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=o>--</span> <span class=nx>skip</span> <span class=o>--</span>
</span></span><span class=line><span class=cl>	<span class=nx>country</span> <span class=p>=</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>ToLower</span><span class=p>(</span><span class=nx>country</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=o>--</span> <span class=nx>skip</span> <span class=o>--</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// ---
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>countryCode</span> <span class=p>=</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>ToLower</span><span class=p>(</span><span class=nx>countryCode</span><span class=p>)</span> 
</span></span></code></pre></td></tr></table></div></div><p>换句话说，以下写法是等价的：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>GEOSITE,PRIVATE,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span>- <span class=l>GEOSITE,private,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span>- <span class=l>GEOIP,cn,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span>- <span class=l>GEOIP,CN,DIRECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 以此类推</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=new-tuic>new tuic</h4><p><a class=link href=https://github.com/MetaCubeX/Clash.Meta/blob/0b1aff575990ea5816cd24b64757b75dc7368db1/adapter/outbound/tuic.go#L120 target=_blank rel=noopener>NewTuic MetaCubeX/Clash.Meta</a></p><h3 id=常见问题汇总>常见问题汇总</h3><ol><li>Windows DNS 策略组问题</li><li>使用 clash 一顿操作连不上公司内网</li></ol><h2 id=reference>Reference</h2><ul><li><a class=link href=https://github.com/Loyalsoldier/clash-rules#rule-providers-%e9%85%8d%e7%bd%ae%e6%96%b9%e5%bc%8f target=_blank rel=noopener>规则上游</a></li><li><a class=link href=https://wiki.metacubex.one/config/rules/rule-provider/#rule-set target=_blank rel=noopener>语法规则</a></li><li><a class=link href=https://wiki.metacubex.one/config/dns/diagram/ target=_blank rel=noopener>Clash.Meta 的 DNS 工作流程</a></li><li><a class=link href=https://wiki.metacubex.one/config/dns/#nameserver-policy target=_blank rel=noopener>域名服务器查询策略</a></li><li><a class=link href=https://www.dnsperf.com/ target=_blank rel=noopener>全球公有DNS服务器性能测试</a></li></ul></section><footer class=article-footer><section class=article-tags><a href=/tags/clash/>Clash</a>
<a href=/tags/clash-meta/>clash-meta</a>
<a href=/tags/clash-verge/>clash-verge</a>
<a href=/tags/clash-dns/>clash-dns</a>
<a href=/tags/dns-router/>dns-router</a>
<a href=/tags/fakeip/>fakeip</a>
<a href=/tags/fakedns/>fakedns</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section><section class=article-views><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-eye-check" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="2"/><path d="M12 19c-4 0-7.333-2.333-10-7 2.667-4.667 6-7 10-7s7.333 2.333 10 7c-.42.736-.858 1.414-1.311 2.033"/><path d="M15 19l2 2 4-4"/></svg><span id=busuanzi_value_page_pv><i class="fa fa-spinner fa-spin"></i></span><span>&nbsp;&nbsp;views</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title></h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/p/mouting-alidrive-locally/><div class=article-image><img src=/p/mouting-alidrive-locally/doharge-08.27fe05f80783b2afc1a99ae30afbef9a_hu13fdd9666faf8189fe2265e8a87a6e60_2048497_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post 『Blog』Mounting Alidrive Locally" data-key=mouting-alidrive-locally data-hash="md5-J/4F+AeDsq/BqZrjCvvvmg=="></div><div class=article-details><h2 class=article-title>『Blog』Mounting Alidrive Locally</h2></div></a></article><article class=has-image><a href=/p/nezha-monitoring/><div class=article-image><img src=/p/nezha-monitoring/wanderer4.9bee2fe0cbce8e6561efb26acbc637c4_huf18331c9a1d279d8d1eb1f131ae90b4b_1493237_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post 『Blog』NeZha Monitoring 从一到无穷大" data-key=nezha-monitoring data-hash="md5-m+4v4MvOjmVh77Jqy8Y3xA=="></div><div class=article-details><h2 class=article-title>『Blog』NeZha Monitoring 从一到无穷大</h2></div></a></article><article class=has-image><a href=/p/google-research-seanet-musiclm/><div class=article-image><img src=/p/google-research-seanet-musiclm/lixin.6532f3b9036b287abd9baa6e6ffbf0f7_hu108383160588985e40f4f4076326a6a7_370693_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post 『Blog』AI 有望成为华语乐坛的下一任周杰伦" data-key=google-research-seanet-musiclm data-hash="md5-ZTLzuQNrKHq9m6pub/vw9w=="></div><div class=article-details><h2 class=article-title>『Blog』AI 有望成为华语乐坛的下一任周杰伦</h2></div></a></article><article class=has-image><a href=/p/chatgpt-antirules/><div class=article-image><img src=/p/chatgpt-antirules/naifan-zhang-4.0c5815704d7dbbc2bfe51f3c0db101fe_hu3e631bccb1a1bbdefca010a85222fc9f_376773_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post 『Blog』ChatGPT Anti Rules" data-key=chatgpt-antirules data-hash="md5-DFgVcE19u8K/5R88DbEB/g=="></div><div class=article-details><h2 class=article-title>『Blog』ChatGPT Anti Rules</h2></div></a></article><article class=has-image><a href=/p/chatgpt-register/><div class=article-image><img src=/p/chatgpt-register/lixin.23c0d1f4ab1eeefa1421bfb4ab576d11_hub61807a84e13a72e03127d9d91db1097_437671_250x150_fill_q75_box_smart1.jpg width=250 height=150 loading=lazy alt="Featured image of post 『Blog』跳出传统，ChatGPT 带你玩转智能对话" data-key=chatgpt-register data-hash="md5-I8DR9Kse7voUIb+0q1dtEQ=="></div><div class=article-details><h2 class=article-title>『Blog』跳出传统，ChatGPT 带你玩转智能对话</h2></div></a></article></div></div></aside><script src=https://utteranc.es/client.js repo=qin2dim/blog-comments issue-term=pathname crossorigin=anonymous async></script><style>.utterances{max-width:unset}</style><script>function setUtterancesTheme(e){let t=document.querySelector(".utterances iframe");t&&t.contentWindow.postMessage({type:"set-theme",theme:`github-${e}`},"https://utteranc.es")}addEventListener("message",e=>{if(e.origin!=="https://utteranc.es")return;setUtterancesTheme(document.documentElement.dataset.scheme)}),window.addEventListener("onColorSchemeChange",e=>{setUtterancesTheme(e.detail)})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2023 Echosec @QIN2DIM</section><section class=powerby>You will to enjoy grander sight / By climing to a greater height.<br>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.12.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#简介>简介</a></li><li><a href=#实验环境>实验环境</a></li><li><a href=#实验方法>实验方法</a></li><li><a href=#配置篇>配置篇</a><ol><li><a href=#引入-default-nameserver--nameserver>引入 default-nameserver & nameserver</a><ol><li><a href=#规则模式---对照组--默认配置>规则模式 - 对照组 | 默认配置</a></li><li><a href=#规则模式---仅设置-nameserver-为-dns-ip>规则模式 - 仅设置 <em>nameserver</em> 为 DNS IP</a></li><li><a href=#规则模式---仅设置-nameserver-为-doh-ip>规则模式 - 仅设置 <em>nameserver</em> 为 DOH: IP</a></li><li><a href=#规则模式---仅设置-nameserver-为-doh-domain>规则模式 - 仅设置 <em>nameserver</em> 为 DOH: domain</a></li></ol></li><li><a href=#引入-namesever-policy>引入 namesever-policy</a><ol><li><a href=#规则模式---同时设置-nameserver-policy-和-nameserver>规则模式 - 同时设置 <em>nameserver-policy</em> 和 <em>nameserver</em></a></li><li><a href=#规则模式---混用-doh>规则模式 - 混用 DOH</a></li><li><a href=#规则模式---仅设置-nameserver-policy-为-doh-ip>规则模式 - 仅设置 <em>nameserver-policy</em> 为 DOH: IP</a></li><li><a href=#规则模式---仅设置-nameserver-policy-为-doh-domain>规则模式 - 仅设置 <em>nameserver-policy</em> 为 DOH: domain</a></li></ol></li><li><a href=#引入-dns-分流>引入 DNS 分流</a><ol><li><a href=#规则模式---域名规则的解析>规则模式 - 域名规则的解析</a></li><li><a href=#规则模式---域名规则的解析---验证>规则模式 - 域名规则的解析 - 验证</a></li><li><a href=#规则模式---ip-规则的解析>规则模式 - IP 规则的解析</a></li><li><a href=#规则模式---ip-规则的解析---原理剖析>规则模式 - IP 规则的解析 - 原理剖析🏴‍☠️</a></li><li><a href=#规则模式---ip-规则的解析---验证>规则模式 - IP 规则的解析 - 验证</a></li><li><a href=#全局模式---全局代理全局直连与全局拒绝>全局模式 - 全局代理，全局直连与全局拒绝</a></li><li><a href=#public-dns---已知的-dns-提供商>Public DNS - 已知的 DNS 提供商</a></li></ol></li></ol></li><li><a href=#原理篇>原理篇</a><ol><li><a href=#clash-flow---dns>Clash flow - DNS</a></li><li><a href=#clash-flow---proxy>Clash flow - Proxy</a></li></ol></li><li><a href=#泄漏篇>泄漏篇</a><ol><li><a href=#dns-泄漏---概念界定>DNS 泄漏 - 概念界定</a></li><li><a href=#dns-泄漏---争议点>DNS 泄漏 - 争议点</a><ol><li><a href=#vpn-的-dns-泄漏>VPN 的 DNS 泄漏</a></li><li><a href=#proxy-的-dns-泄漏>Proxy 的 DNS 泄漏</a></li></ol></li><li><a href=#dns-泄漏---检测工具>DNS 泄漏 - 检测工具</a></li><li><a href=#dns-泄漏---检测原理>DNS 泄漏 - 检测原理</a></li><li><a href=#如何避免-dns-泄漏>如何避免 DNS 泄漏</a></li></ol></li><li><a href=#触类旁通>触类旁通</a><ol><li><a href=#tunnel-mode>TUNNEL Mode</a></li><li><a href=#enhanced-mode>Enhanced Mode</a><ol><li><a href=#dnsmaping>DNSMaping</a></li><li><a href=#fakeip-clash--meta>FakeIP: Clash & Meta</a></li><li><a href=#fakedns-v2ray--sing-box>FakeDNS: v2ray & sing-box</a></li><li><a href=#l3-loss-but-deepin-magic>L3: Loss but deepin magic</a></li></ol></li><li><a href=#软路由---物理超度>软路由 - 物理超度</a></li></ol></li><li><a href=#一叶知秋>一叶知秋</a><ol><li><a href=#处理-squad-eac-反外挂验证>处理 Squad EAC 反外挂验证</a></li><li><a href=#解锁流媒体>解锁流媒体</a></li><li><a href=#绕过-chatgpt-网络审查>绕过 ChatGPT 网络审查</a></li></ol></li><li><a href=#天外飞仙>天外飞仙</a><ol><li><a href=#基于-rust-实现-pbq-quic-based-拥塞控制算法>基于 Rust 实现 PBQ QUIC-based 拥塞控制算法</a></li></ol></li><li><a href=#clashmeta-参考配置>Clash.Meta 参考配置</a></li><li><a href=#whats-more>What&rsquo;s more</a><ol><li><a href=#术语表>术语表</a></li><li><a href=#源码阅读>源码阅读</a><ol><li><a href=#初始化配置>初始化配置</a></li><li><a href=#dnsmode-alias>DNSMode Alias</a></li><li><a href=#type-rawdns-struct>type RawDNS struct</a></li><li><a href=#dns-默认配置>DNS 默认配置</a></li><li><a href=#type-pool-struct>type Pool struct</a></li><li><a href=#geositegeoip-大小写不敏感>GEOSITE，GEOIP 大小写不敏感</a></li><li><a href=#new-tuic>new tuic</a></li></ol></li><li><a href=#常见问题汇总>常见问题汇总</a></li></ol></li><li><a href=#reference>Reference</a></li></ol></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>